(()=>{var e={991:(e,t,r)=>{var n=r(928),a=r(523),o=r(807),i=(r(549),r(744)),s=r(17);e.exports={entry:{server:"./app.mjs"},output:{path:n.join(__dirname,"dist"),publicPath:"/",filename:"[name].js"},mode:"development",target:"node",node:{__dirname:!1,__filename:!1},externals:[a()],resolve:{extensions:[".js",".mjs"],alias:{"@app":n.resolve(__dirname,"app/"),"@config":n.resolve(__dirname,"config/"),"@handlers":n.resolve(__dirname,"handlers/"),"@public":n.resolve(__dirname,"public/"),"@routes":n.resolve(__dirname,"routes/"),"@test":n.resolve(__dirname,"test/")}},module:{rules:[{test:/\.(mjs|js)$/,exclude:/node_modules/,use:{loader:"babel-loader"}}]},plugins:[new o.HotModuleReplacementPlugin,new i,new s]}},744:e=>{"use strict";e.exports=require("dotenv-webpack")},17:e=>{"use strict";e.exports=require("eslint-webpack-plugin")},549:e=>{"use strict";e.exports=require("html-webpack-plugin")},807:e=>{"use strict";e.exports=require("webpack")},523:e=>{"use strict";e.exports=require("webpack-node-externals")},928:e=>{"use strict";e.exports=require("path")}},t={};function r(n){var a=t[n];if(void 0!==a)return a.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,r),o.exports}(()=>{"use strict";const e=require("dotenv");var t=r(928),n=".env.".concat("development");e.config({path:t.resolve(n)});const a=require("@babel/runtime/helpers/classCallCheck"),o=require("@babel/runtime/helpers/createClass");var i=r(807);const s=require("webpack-dev-middleware"),u=require("webpack-hot-middleware");var c=r(991);const l=require("express"),d=require("ajv"),p=require("ajv-formats"),f=require("ajv-errors"),m=require("ajv-dates"),h={$id:"http://example.com/schemas/defs.json#",definitions:{integer:{type:"integer"},intPositivo:{type:"integer",minimun:1},intOrNull:{type:["null","integer"]},double:{type:"number"},string:{type:"string"},stringOrNull:{type:["null","string"]},date:{type:"string",format:"date",errorMessage:{format:"El formato de la fecha es YYYY-MM-DD"}},fechaMenorActual:{type:"string",format:"date",isAfter:Date.now(),errorMessage:{format:"El formato de la fecha es YYYY-MM-DD",properties:{isAfter:"La fecha debe ser mayor a la actual"}}},email:{type:"string",pattern:"^([a-zA-Z0-9./^S+$/<*>!#$%&'+/=?^_`{|}~-]+([s]{0}))+?@[a-zA-Z]+([.]{1})[a-zA-Z]+[s]{0}[.]?[a-zA-Z]{2,}([.]{0})[s]{0}$",errorMessage:{type:"El correo electronico debe ser alfanumerico ",pattern:"Tiene que ingresar un correo valido"}},password:{type:"string",pattern:"^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[$@#$!%*?&-_.:])([A-Za-zd$@$!%*?&]|[^ d]){8,20}$",errorMessage:{pattern:"La contraseña debe tener entre 8 y 16 caracteres, al menos un dígito, al menos una minúscula, al menos una mayúscula y al menos un caracter no alfanumérico."}},decimal:{type:"string",pattern:"^[0-9]+([.][0-9]+)?$",errorMessage:{type:"Debe ser decimal",pattern:"EL campo debe ser un entero o decimal."}},arrayIntUnico:{type:"array",uniqueItems:!0,items:{type:"integer"},errorMessage:{uniqueItems:"No puede existir paramatros identicos en el array"}},arrayInt:{type:"array",minItems:1,items:{type:"integer"}},arrayString:{type:"array",minItems:1,items:{type:"string"}},codigo:{type:["null","string"],maxLength:5,errorMessage:{type:"El codigo del perfil debe ser de tipo alfanumérico",maxLength:"El codigo debe ser maximo 5 caracteres"}}}};var v=(0,m.dates)(new d({allErrors:!0,$data:!0}));p(v),f(v),v.addSchema(h);const y=v,b=require("@babel/runtime/helpers/defineProperty");var _=o((function e(){a(this,e)}));b(_,"HTTP_OK",200),b(_,"HTTP_CREATED",201),b(_,"HTTP_BAD_REQUEST",400),b(_,"HTTP_UNAUTHORIZED",401),b(_,"HTTP_FORBIDDEN",403),b(_,"HTTP_NOT_FOUND",404),b(_,"HTTP_UNPROCESSABLE_ENTITY",422),b(_,"HTTP_NOT_MODIFIED",304),b(_,"HTTP_INTERNAL_SERVER_ERROR",500);const w=require("@babel/runtime/helpers/possibleConstructorReturn"),g=require("@babel/runtime/helpers/getPrototypeOf"),x=require("@babel/runtime/helpers/inherits");function k(e,t,r){return t=g(t),w(e,E()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function E(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(E=function(){return!!e})()}var T=function(e){function t(e,r,n){var o,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return a(this,t),o=k(this,t,[n]),Object.setPrototypeOf(o,(this instanceof t?this.constructor:void 0).prototype),o.name=e,o.description=n,o.statusCode=r,o.isOperational=i,Error.captureStackTrace(o),o}return x(t,e),o(t)}(require("@babel/runtime/helpers/wrapNativeSuper")(Error));const O=require("mongoose"),R=require("@babel/runtime/helpers/asyncToGenerator"),S=require("@babel/runtime/regenerator");var N="mongodb://".concat("admin",":").concat("admin","@").concat("0.0.0.0",":").concat("27019","/").concat("admin"),q=function(){return o((function e(){a(this,e)}),null,[{key:"connection",value:(e=R(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("true"!==process.env.ENABLED_BITACORA_MONGODB){e.next=9;break}return e.prev=1,e.next=4,O.connect(N,{useNewUrlParser:!0,useUnifiedTopology:!0});case 4:e.next=9;break;case 6:e.prev=6,e.t0=e.catch(1),console.log(e.t0);case 9:case"end":return e.stop()}}),e,null,[[1,6]])}))),function(){return e.apply(this,arguments)})}]);var e}(),j=new(0,O.Schema)({id_bitacora:String,codigo:Number,mensaje:String,trace:String,content:Object,fecha_hora_reg:{type:Date,default:Date.now()}});q.connection();const A=O.model("error",j,"errors");var P=function(){function e(){a(this,e)}return o(e,null,[{key:"logError",value:function(e,t){e.usuario&&"true"===process.env.ENABLED_BITACORA_MONGODB&&new A({id_bitacora:e.bitacora?e.bitacora.id:null,codigo:t.statusCode,mensaje:t.message,trace:t.stack,content:t}).save()}},{key:"logErrorMiddleware",value:function(t,r,n,a){e.logError(r,t),a(t)}},{key:"handlerError",value:function(t,r,n,a){var o=I.call(e,t);return t.statusCode&&(o=t.statusCode),n.status(o).json({err:t,stack:t.stack})}},{key:"isOPerationalError",value:function(e){return e instanceof T&&e.isOperational}}])}();function I(e){var t={badRequest:{names:["SequelizeValidationError","JsonSchemaValidation","SequelizeUniqueConstraintError"],code:_.HTTP_BAD_REQUEST},unauthorized:{names:["TokenExpiredError","JsonWebTokenError"],code:_.HTTP_UNAUTHORIZED},internal:{names:["SequelizeForeignKeyConstraintError"],code:_.HTTP_INTERNAL_SERVER_ERROR}};for(var r in t)if(t[r].names.includes(e.name))return t[r].code;return _.HTTP_INTERNAL_SERVER_ERROR}const z=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"body",r=y.compile(e);return function(e,n,a){if(!r(e[t])){var o=r.errors,i={message:"BAD REQUEST",statusCode:_.HTTP_BAD_REQUEST,content:o};P.logError(e,i),console.log(o);var s=o.map((function(e){var t={};return t.message=e.message,t}));return n.status(_.HTTP_BAD_REQUEST).json(s)}a()}},M=require("bcryptjs"),K=require("moment-timezone"),D=require("jsonwebtoken"),L=require("speakeasy"),B=require("sequelize"),H={connections:{postgres:{motor:"postgres",options:{db_host:"localhost",db_port:"5432",db_name:"funeraria2",db_username:"postgres",db_password:"postgres"}}},default:"postgres"};var U=function(){return o((function e(){a(this,e)}),null,[{key:"connection",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=H.default;return e=t?H.connections[t]:H.connections[r],new B.Sequelize(e.options.db_name,e.options.db_username,e.options.db_password,{host:e.options.db_host,port:e.options.db_port,dialect:e.motor,logging:!0})}},{key:"testing",value:(e=R(S.mark((function e(){var t,r=arguments;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.length>0&&void 0!==r[0]?r[0]:null,e.prev=1,e.next=4,this.connection(t).authenticate();case 4:return e.abrupt("return",!0);case 7:return e.prev=7,e.t0=e.catch(1),e.abrupt("return",!1);case 10:case"end":return e.stop()}}),e,this,[[1,7]])}))),function(){return e.apply(this,arguments)})}]);var e}();function C(e,t,r){return t=g(t),w(e,G()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function G(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(G=function(){return!!e})()}var $=function(e){function t(){return a(this,t),C(this,t,arguments)}return x(t,e),o(t)}(B.Model);$.init({id:{type:B.Sequelize.INTEGER,primaryKey:!0,autoIncrement:!0},id_ruta:{type:B.Sequelize.INTEGER},id_rol:{type:B.Sequelize.INTEGER}},{timestamps:!1,updatedAt:!1,sequelize:U.connection(),tableName:"mnt_ruta_rol"});const F=$;function V(e,t,r){return t=g(t),w(e,Y()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function Y(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(Y=function(){return!!e})()}var Z=function(e){function t(){return a(this,t),V(this,t,arguments)}return x(t,e),o(t,[{key:"toJSON",value:function(){return{id:this.id,nombre:this.nombre,uri:this.uri,nombre_uri:this.nombre_uri,icono:this.icono,admin:this.admin,mostrar:this.mostrar,orden:this.orden,id_ruta_padre:this.id_ruta_padre,childrens:this.rutas}}}],[{key:"associate",value:function(){this.belongsToMany(we,{through:F,foreignKey:"id_ruta",otherKey:"id_rol",onDelete:"CASCADE",hooks:!0}),this.hasMany(t,{foreignKey:"id_ruta_padre"}),this.hasOne(t,{foreignKey:"id_ruta_padre"})}},{key:"getById",value:(r=R(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.findOne({where:{id:t},attributes:["id"],include:[{model:we,attributes:["id","name"],through:{attributes:[]}}]}));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})}]);var r}(B.Model);Z.init({id:{type:B.Sequelize.INTEGER,primaryKey:!0,autoIncrement:!0},nombre:{type:B.Sequelize.STRING(50),allowNull:!1},uri:{type:B.Sequelize.TEXT},nombre_uri:{type:B.Sequelize.TEXT},mostrar:{type:B.Sequelize.BOOLEAN,allowNull:!1},icono:{type:B.Sequelize.STRING(255)},orden:{type:B.Sequelize.INTEGER},admin:{type:B.Sequelize.BOOLEAN},publico:{type:B.Sequelize.BOOLEAN},id_ruta_padre:{type:B.Sequelize.INTEGER}},{timestamps:!1,sequelize:U.connection(),tableName:"mnt_ruta"});const Q=Z;function J(e,t,r){return t=g(t),w(e,W()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function W(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(W=function(){return!!e})()}var X=function(e){function t(){return a(this,t),J(this,t,arguments)}return x(t,e),o(t)}(B.Model);X.init({id:{type:B.Sequelize.INTEGER,primaryKey:!0,autoIncrement:!0},id_perfil:{type:B.Sequelize.INTEGER,allowNull:!1},id_usuario:{type:B.Sequelize.INTEGER}},{timestamps:!1,updatedAt:!1,sequelize:U.connection(),tableName:"mnt_usuario_perfil"});const ee=X;function te(e,t,r){return t=g(t),w(e,re()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function re(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(re=function(){return!!e})()}var ne=function(e){function t(){return a(this,t),te(this,t,arguments)}return x(t,e),o(t)}(B.Model);ne.init({id:{type:B.Sequelize.INTEGER,primaryKey:!0,autoIncrement:!0},id_perfil:{type:B.Sequelize.INTEGER},id_rol:{type:B.Sequelize.INTEGER}},{timestamps:!1,updatedAt:!1,sequelize:U.connection(),tableName:"mnt_perfil_rol"});const ae=ne;function oe(e,t,r){return t=g(t),w(e,ie()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function ie(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(ie=function(){return!!e})()}var se=function(e){function t(){return a(this,t),oe(this,t,arguments)}return x(t,e),o(t,[{key:"toJSON",value:function(){return{id:this.id,codigo:this.codigo,nombre:this.nombre,roles:this.Rols}}}],[{key:"associate",value:function(){this.belongsToMany(De,{through:ee,foreignKey:"id_perfil",otherKey:"id_usuario",as:"usuarios_perfil"}),this.belongsToMany(we,{through:ae,foreignKey:"id_perfil",otherKey:"id_rol",as:"roles_perfil"}),this.belongsToMany(De,{through:ee,foreignKey:"id_perfil",otherKey:"id_usuario"}),this.belongsToMany(we,{through:ae,foreignKey:"id_perfil",otherKey:"id_rol"})}}])}(B.Model);se.init({id:{type:B.Sequelize.INTEGER,primaryKey:!0,autoIncrement:!0},nombre:{type:B.Sequelize.STRING(30),allowNull:!1},codigo:{type:B.Sequelize.STRING(5)}},{timestamps:!1,sequelize:U.connection(),tableName:"mnt_perfil"});const ue=se;function ce(e,t,r){return t=g(t),w(e,le()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function le(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(le=function(){return!!e})()}var de=function(e){function t(){return a(this,t),ce(this,t,arguments)}return x(t,e),o(t)}(B.Model);de.init({id_usuario:{type:B.Sequelize.INTEGER,primaryKey:!0},id_rol:{type:B.Sequelize.INTEGER,primaryKey:!0}},{timestamps:!1,updatedAt:!1,sequelize:U.connection(),tableName:"mnt_usuario_rol"});const pe=de;function fe(e,t,r){return t=g(t),w(e,me()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function me(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(me=function(){return!!e})()}var he=function(e){function t(){return a(this,t),fe(this,t,arguments)}return x(t,e),o(t,null,[{key:"associate",value:function(){this.hasMany(we,{foreignKey:"id_tipo_rol"})}}])}(B.Model);he.init({id:{type:B.Sequelize.INTEGER,primaryKey:!0,autoIncrement:!0},name:{type:B.Sequelize.STRING(255),allowNull:!1},prefijo:{type:B.Sequelize.STRING(255),allowNull:!1}},{timestamps:!1,sequelize:U.connection(),tableName:"ctl_tipo_rol"});const ve=he;function ye(e,t,r){return t=g(t),w(e,be()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function be(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(be=function(){return!!e})()}var _e=function(e){function t(){return a(this,t),ye(this,t,arguments)}return x(t,e),o(t,null,[{key:"associate",value:function(){this.belongsToMany(Q,{through:F,foreignKey:"id_rol",otherKey:"id_ruta"}),this.belongsToMany(ue,{through:ae,foreignKey:"id_rol",otherKey:"id_perfil"}),this.belongsToMany(De,{through:pe,foreignKey:"id_rol",otherKey:"id_usuario"}),this.belongsTo(ve,{foreignKey:"id_tipo_rol"})}}])}(B.Model);_e.init({id:{type:B.Sequelize.INTEGER,primaryKey:!0,autoIncrement:!0},name:{type:B.Sequelize.STRING(255),allowNull:!1},id_tipo_rol:{type:B.Sequelize.INTEGER,allowNull:!1}},{timestamps:!1,sequelize:U.connection(),tableName:"mnt_rol"});const we=_e;function ge(e,t,r){return t=g(t),w(e,xe()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function xe(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(xe=function(){return!!e})()}var ke=function(e){function t(){return a(this,t),ge(this,t,arguments)}return x(t,e),o(t,null,[{key:"associate",value:function(){this.belongsTo(De,{foreignKey:"id_usuario",as:"usuario_refreshtoken"}),this.belongsTo(De,{foreignKey:"id_usuario"})}}])}(B.Model),Ee={id:{type:B.Sequelize.INTEGER,primaryKey:!0,autoIncrement:!0},refresh_token:{type:B.Sequelize.STRING},id_usuario:{type:B.Sequelize.INTEGER,allowNull:!1,references:{model:"mnt_usuario",key:"id"}},valid:{type:B.Sequelize.DATE}};ke.init(Ee,{timestamps:!1,tableName:"refresh_tokens",sequelize:U.connection()});const Te=ke;function Oe(e,t,r){return t=g(t),w(e,Re()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function Re(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(Re=function(){return!!e})()}var Se=function(e){function t(){return a(this,t),Oe(this,t,arguments)}return x(t,e),o(t)}(B.Model);Se.init({id:{type:B.Sequelize.INTEGER,primaryKey:!0,autoIncrement:!0},id_usuario:{type:B.Sequelize.INTEGER},id_metodo:{type:B.Sequelize.INTEGER},secret_key:{type:B.Sequelize.STRING},temporal_key:{type:B.Sequelize.STRING},is_primary:{type:B.Sequelize.BOOLEAN},verified:{type:B.Sequelize.BOOLEAN}},{timestamps:!1,sequelize:U.connection(),tableName:"mnt_metodo_autenticacion_usuario"});const Ne=Se;function qe(e,t,r){return t=g(t),w(e,je()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function je(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(je=function(){return!!e})()}var Ae=function(e){function t(){return a(this,t),qe(this,t,arguments)}return x(t,e),o(t,[{key:"toJSON",value:function(){var e,t;return{id:this.id,nombre:this.nombre,descripcion:this.descripcion,icono:this.icono,is_primary:(null===(e=this.MetodoAutenticacionUsuario)||void 0===e?void 0:e.is_primary)||!1,verified:null===(t=this.MetodoAutenticacionUsuario)||void 0===t?void 0:t.verified,configured:!!this.MetodoAutenticacionUsuario}}}],[{key:"associate",value:function(){this.belongsToMany(De,{through:Ne,foreignKey:"id_metodo",otherKey:"id_usuario"}),this.hasOne(Ne,{foreignKey:"id_metodo"})}}])}(B.Model);Ae.init({id:{type:B.Sequelize.INTEGER,primaryKey:!0,autoIncrement:!0},nombre:{type:B.Sequelize.STRING},descripcion:{type:B.Sequelize.STRING},icono:{type:B.Sequelize.STRING}},{timestamps:!1,sequelize:U.connection(),tableName:"mnt_metodo_autenticacion"});const Pe=Ae;function Ie(e,t,r){return t=g(t),w(e,ze()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function ze(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(ze=function(){return!!e})()}var Me={id:{type:B.Sequelize.INTEGER,primaryKey:!0,autoIncrement:!0},email:{type:B.Sequelize.STRING},password:{type:B.Sequelize.TEXT},last_login:{type:B.Sequelize.STRING},is_suspended:{type:B.Sequelize.BOOLEAN},token_valid_after:{type:B.Sequelize.STRING},two_factor_status:{type:B.Sequelize.BOOLEAN},verified:{type:B.Sequelize.BOOLEAN},nombre:{type:B.Sequelize.STRING}},Ke=function(e){function t(){return a(this,t),Ie(this,t,arguments)}return x(t,e),o(t,[{key:"toJSON",value:function(){return{id:this.id,email:this.email,last_login:this.last_login,is_suspended:this.is_suspended,perfiles:this.Perfils,roles:this.Rols,nombre:this.nombre}}}],[{key:"associate",value:function(){this.belongsToMany(we,{through:pe,foreignKey:"id_usuario",otherKey:"id_rol"}),this.belongsToMany(Pe,{through:Ne,foreignKey:"id_usuario",otherKey:"id_metodo"}),this.hasMany(Te,{foreignKey:"id_usuario"}),this.belongsToMany(ue,{through:ee,foreignKey:"id_usuario",otherKey:"id_perfil"})}},{key:"getById",value:(r=R(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.findOne({where:{id:t},attributes:["id","email"],include:[{model:ue,attributes:["id","nombre"],through:{attributes:[]}},{model:we,attributes:["id","name"],through:{attributes:[]}}]}));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})}]);var r}(B.Model);Ke.init(Me,{timestamps:!0,updatedAt:!1,createdAt:"created_at",sequelize:U.connection(),tableName:"mnt_usuario"});const De=Ke;function Le(e,t,r){return t=g(t),w(e,Be()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function Be(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(Be=function(){return!!e})()}var He=function(e){function t(){return a(this,t),Le(this,t,arguments)}return x(t,e),o(t,null,[{key:"associate",value:function(){this.belongsTo(at,{foreignKey:"id_venta"}),this.belongsTo(Fe,{foreignKey:"id_servicio"})}}])}(B.Model);He.init({id:{type:B.Sequelize.INTEGER,primaryKey:!0,autoIncrement:!0},id_venta:{type:B.Sequelize.UUID,allowNull:!1},id_servicio:{type:B.Sequelize.INTEGER,allowNull:!1},fecha_defuncion:{type:B.Sequelize.DATE,allowNull:!0},cantidad:{type:B.Sequelize.INTEGER,allowNull:!1},subtotal:{type:B.Sequelize.DECIMAL,allowNull:!1,defaultValue:0}},{timestamps:!1,sequelize:U.connection(),tableName:"mnt_servicio_venta"});const Ue=He;function Ce(e,t,r){return t=g(t),w(e,Ge()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function Ge(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(Ge=function(){return!!e})()}var $e=function(e){function t(){return a(this,t),Ce(this,t,arguments)}return x(t,e),o(t,null,[{key:"associate",value:function(){this.belongsTo(et,{foreignKey:"id_tipo_servicio"}),this.hasMany(Ue,{foreignKey:"id_servicio"})}}])}(B.Model);$e.init({id:{type:B.Sequelize.INTEGER,primaryKey:!0,autoIncrement:!0},id_tipo_servicio:{type:B.Sequelize.INTEGER,allowNull:!1},nombre:{type:B.Sequelize.STRING(250),allowNull:!1},fecha:{type:B.Sequelize.DATE,allowNull:!1},descripcion:{type:B.Sequelize.STRING(250),allowNull:!1},precio_base:{type:B.Sequelize.DECIMAL,allowNull:!1},costo:{type:B.Sequelize.DECIMAL,allowNull:!1}},{timestamps:!1,sequelize:U.connection(),tableName:"mnt_servicio"});const Fe=$e;function Ve(e,t,r){return t=g(t),w(e,Ye()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function Ye(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(Ye=function(){return!!e})()}var Ze=function(e){function t(){return a(this,t),Ve(this,t,arguments)}return x(t,e),o(t,null,[{key:"associate",value:function(){this.belongsTo(pt,{foreignKey:"id_tipo_pago"}),this.belongsTo(at,{foreignKey:"id_venta"})}}])}(B.Model);Ze.init({id:{type:B.Sequelize.INTEGER,primaryKey:!0,autoIncrement:!0},id_tipo_pago:{type:B.Sequelize.INTEGER,allowNull:!1},id_venta:{type:B.Sequelize.UUID,allowNull:!1},total:{type:B.Sequelize.DECIMAL,allowNull:!1},cantidad_servicios:{type:B.Sequelize.INTEGER,allowNull:!1},cambio:{type:B.Sequelize.DECIMAL,allowNull:!1},cantidad_pagada:{type:B.Sequelize.DECIMAL,allowNull:!1}},{timestamps:!1,sequelize:U.connection(),tableName:"mnt_detalle_venta"});const Qe=Ze;function Je(e,t,r){return t=g(t),w(e,We()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function We(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(We=function(){return!!e})()}var Xe=function(e){function t(){return a(this,t),Je(this,t,arguments)}return x(t,e),o(t,null,[{key:"associate",value:function(){this.hasMany(Fe,{foreignKey:"id_tipo_servicio"})}}])}(B.Model);Xe.init({id:{type:B.Sequelize.INTEGER,primaryKey:!0,autoIncrement:!0},nombre:{type:B.Sequelize.STRING(255),allowNull:!1}},{timestamps:!1,sequelize:U.connection(),tableName:"ctl_tipo_servicio"});const et=Xe;function tt(e,t,r){return t=g(t),w(e,rt()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function rt(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(rt=function(){return!!e})()}var nt=function(e){function t(){return a(this,t),tt(this,t,arguments)}return x(t,e),o(t,null,[{key:"associate",value:function(){this.belongsTo(ut,{foreignKey:"id_cliente"}),this.hasMany(Ue,{foreignKey:"id_venta"}),this.hasMany(Qe,{foreignKey:"id_venta"})}}])}(B.Model);nt.init({numero_factura:{type:B.Sequelize.UUID,primaryKey:!0,defaultValue:B.Sequelize.UUIDV4},id_cliente:{type:B.Sequelize.INTEGER,allowNull:!0},fecha:{type:B.Sequelize.DATE,allowNull:!1,defaultValue:B.Sequelize.NOW}},{timestamps:!1,sequelize:U.connection(),tableName:"mnt_venta"});const at=nt;function ot(e,t,r){return t=g(t),w(e,it()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function it(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(it=function(){return!!e})()}var st=function(e){function t(){return a(this,t),ot(this,t,arguments)}return x(t,e),o(t,null,[{key:"associate",value:function(){this.hasMany(at,{foreignKey:"id_cliente"})}}])}(B.Model);st.init({id:{type:B.Sequelize.INTEGER,primaryKey:!0,autoIncrement:!0},nombre:{type:B.Sequelize.STRING(255),allowNull:!1},dui:{type:B.Sequelize.STRING(10),allowNull:!1},email:{type:B.Sequelize.STRING(255),allowNull:!1}},{timestamps:!1,sequelize:U.connection(),tableName:"mnt_cliente"});const ut=st;function ct(e,t,r){return t=g(t),w(e,lt()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function lt(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(lt=function(){return!!e})()}var dt=function(e){function t(){return a(this,t),ct(this,t,arguments)}return x(t,e),o(t,null,[{key:"associate",value:function(){this.hasMany(Qe,{foreignKey:"id_tipo_pago"})}}])}(B.Model);dt.init({id:{type:B.Sequelize.INTEGER,primaryKey:!0,autoIncrement:!0},nombre:{type:B.Sequelize.STRING(255),allowNull:!1}},{timestamps:!1,sequelize:U.connection(),tableName:"ctl_tipo_pago"});const pt=dt;function ft(e,t,r){return t=g(t),w(e,mt()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function mt(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(mt=function(){return!!e})()}et.associate(),De.associate(),Te.associate(),ue.associate(),we.associate(),Q.associate(),Pe.associate(),Fe.associate(),at.associate(),ut.associate(),Qe.associate(),pt.associate(),Ue.associate();var ht=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"No autenticado";return a(this,t),ft(this,t,["UNAUTHORIZED",_.HTTP_UNAUTHORIZED,e])}return x(t,e),o(t)}(T);const vt=require("uuid");var yt=function(){return o((function e(){a(this,e)}),null,[{key:"createToken",value:(t=R(S.mark((function e(t,r){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,n){D.sign(t,r,{expiresIn:"60m"},(function(t,r){t?n(t):e(r)}))})));case 1:case"end":return e.stop()}}),e)}))),function(e,r){return t.apply(this,arguments)})},{key:"refresh_token",value:(e=R(S.mark((function e(t){var r,n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=(0,vt.v4)(),e.next=3,Te.create({refresh_token:r,id_usuario:t.id,valid:K().add("2","h").tz("America/El_Salvador").format()});case 3:return n=e.sent,e.abrupt("return",n.refresh_token);case 5:case"end":return e.stop()}}),e)}))),function(t){return e.apply(this,arguments)})}]);var e,t}();function bt(e,t,r){return t=g(t),w(e,_t()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function _t(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(_t=function(){return!!e})()}var wt=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Recurso no encontrado";return a(this,t),bt(this,t,["NOT_FOUND",_.HTTP_NOT_FOUND,e])}return x(t,e),o(t)}(T);const gt=require("@babel/runtime/helpers/toConsumableArray"),xt=require("nodemailer"),kt=require("mjml");var Et=xt.createTransport({host:process.env.MAIL_HOST,port:process.env.MAIL_PORT,secure:"true"===process.env.MAIL_SECURE,auth:{user:process.env.MAIL_USER,pass:process.env.MAIL_PASS}}),Tt=function(){return o((function e(){a(this,e)}),null,[{key:"sendMail",value:(e=R(S.mark((function e(t){var r,n,a,o,i,s,u,c,l,d,p,f;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.email,n=t.header,a=t.subject,o=t.message,i=t.body,s=void 0===i?[]:i,u=t.sections,c=void 0===u?[]:u,l=kt({tagName:"mjml",attributes:{},children:[{tagName:"mj-body",attributes:{},children:[{tagName:"mj-section",attributes:{},children:[{tagName:"mj-column",attributes:{},children:[{tagName:"mj-image",attributes:{src:"https://next.salud.gob.sv/index.php/s/AHEMQ38JR93fnXQ/download",width:"350px"}}].concat(gt(n),[{tagName:"mj-spacer",attributes:{"css-class":"primary"}},{tagName:"mj-divider",attributes:{"border-width":"3px","border-color":"#175efb"}},{tagName:"mj-text",attributes:{align:"center","font-weight":"bold","font-size":"12px"},content:o}],gt(s))}]}].concat(gt(c))}]}),d=l.html,e.next=4,Et.verify();case 4:return p={from:"".concat("funeraria"," <").concat(process.env.MAIL_USER,">"),to:r,subject:a,html:d},e.next=7,Et.sendMail(p);case 7:return f=e.sent,e.abrupt("return",f);case 9:case"end":return e.stop()}}),e)}))),function(t){return e.apply(this,arguments)})}]);var e}();function Ot(e,t,r){return t=g(t),w(e,Rt()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function Rt(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(Rt=function(){return!!e})()}var St=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Unprocessable Entity";return a(this,t),Ot(this,t,["UNPROCESSABLE_ENTITY",_.HTTP_UNPROCESSABLE_ENTITY,e])}return x(t,e),o(t)}(T),Nt=function(){return o((function e(){a(this,e)}),null,[{key:"roles",value:(e=R(S.mark((function e(t){var r,n,a,o,i=arguments;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=i.length>1&&void 0!==i[1]?i[1]:"name",e.next=3,De.findOne({include:[we,{model:ue,include:[we]}],where:{id:t}});case 3:return n=e.sent,a=n.Perfils.reduce((function(e,t){return gt(t.Rols)}),[]),console.log(a),o=new Set(n.Rols.concat(a).map((function(e){return e[r]}))),e.abrupt("return",gt(o));case 8:case"end":return e.stop()}}),e)}))),function(t){return e.apply(this,arguments)})}]);var e}(),qt=function(){return o((function e(){a(this,e)}),null,[{key:"isGranted",value:(r=R(S.mark((function e(t,r){var n,a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Nt.roles(t);case 2:return n=e.sent,e.next=5,n.some((function(e){return e===r}));case 5:return a=e.sent,e.abrupt("return",a);case 7:case"end":return e.stop()}}),e)}))),function(e,t){return r.apply(this,arguments)})},{key:"generateTwoFactorAuthCode",value:(t=R(S.mark((function e(t){var r;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,L.generateSecret({name:"".concat("funeraria"," ").concat(t),issuer:"funeraria"});case 2:return r=e.sent,e.abrupt("return",{secret_code:r.base32,qrCode:r.otpauth_url});case 4:case"end":return e.stop()}}),e)}))),function(e){return t.apply(this,arguments)})},{key:"verifyTwoFactorAuthCode",value:(e=R(S.mark((function e(t){var r,n,a,o,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.code,n=t.secretKey,a=t.time,o=t.step,i={secret:n,encoding:"base32",token:r},a&&(i.window=Number(a),i.step=o||10),e.abrupt("return",L.totp.verify(i));case 4:case"end":return e.stop()}}),e)}))),function(t){return e.apply(this,arguments)})}]);var e,t,r}();function jt(e,t,r){return t=g(t),w(e,At()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function At(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(At=function(){return!!e})()}var Pt=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Valores no válidos";return a(this,t),jt(this,t,["BAD_REQUEST",_.HTTP_BAD_REQUEST,e])}return x(t,e),o(t)}(T),It=function(){function e(){a(this,e)}return o(e,null,[{key:"twoFactorList",value:(m=R(S.mark((function e(t,r){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Pe.findAll();case 2:n=e.sent,r.status(_.HTTP_OK).json(n);case 4:case"end":return e.stop()}}),e)}))),function(e,t){return m.apply(this,arguments)})},{key:"confirmUser",value:(f=R(S.mark((function e(t,r){var n,a,o;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=t.params.token)){e.next=10;break}if(a=D.verify(n,"clave_secreta"),!(o=a.idUsuario)){e.next=9;break}return e.next=6,De.update({is_suspended:!1,last_login:K().tz("America/El_Salvador").format(),verified:!0},{where:{id:o}});case 6:r.status(_.HTTP_OK).send({message:"El usuario ha sido verificado con exito"}),e.next=10;break;case 9:throw Pt("El id de usuario es requerido");case 10:case"end":return e.stop()}}),e)}))),function(e,t){return f.apply(this,arguments)})},{key:"login",value:(p=R(S.mark((function t(r,n){var a,o,i,s,u,c,l,d,p,f,m,h,v,y;return S.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a=r.body,o=a.email,i=a.password,t.next=3,De.findOne({where:{email:o},attributes:["id","email","password","is_suspended","last_login","verified","two_factor_status","nombre"],include:[{model:Pe,attributes:["id","nombre","icono"],through:{attributes:["is_primary","id"]}}]});case 3:if(s=t.sent){t.next=6;break}throw new ht("Credenciales no validas");case 6:if(M.compareSync(i,s.password)){t.next=9;break}throw new ht("Credenciales no validas");case 9:if(s.verified){t.next=19;break}return u=s.id,t.next=13,yt.createToken({idUsuario:u},"clave_secreta");case 13:return c=t.sent,l=[{tagName:"mj-button",attributes:{width:"80%",padding:"5px 10px","font-size":"20px","background-color":"#175efb","border-radius":"99px"},content:"Hola ".concat(s.email)}],d=[{tagName:"mj-button",attributes:{width:"80%",padding:"5px 10px","font-size":"20px","background-color":"#175efb",href:"".concat("https://google.com","/verify-mail/").concat(c)},content:"VERIFICAR MI CUENTA"}],t.next=18,Tt.sendMail({email:s.email,header:l,subject:"Verificacion de correo electronico",message:"Para verificar tu cuenta debes de hacer click en el siguiente enlace:",body:d});case 18:return t.abrupt("return",n.status(_.HTTP_OK).json({message:"Por favor verificar la cuenta por medio del correo que se le ha enviado"}));case 19:if(!s.is_suspended){t.next=21;break}throw new ht("El usuario se encuentra suspendido");case 21:return t.next=23,s.update({last_login:K().tz("America/El_Salvador").format()});case 23:return p=s.MetodoAutenticacions.map((function(e){return{nombre:e.nombre,descripcion:e.descripcion,icono:e.icono,id:e.id,is_primary:e.MetodoAutenticacionUsuario.is_primary,id_metodo_usuario:e.MetodoAutenticacionUsuario.id}})),f=p.find((function(e){return e.is_primary})),t.next=27,Nt.roles(s.id);case 27:if(m=t.sent,h={id:s.id,email:s.email,last_login:s.last_login,two_factor_status:s.two_factor_status,auth_methods:p,nombre:s.nombre},v={},y={user:h},s.two_factor_status){t.next=36;break}return y.roles=m,t.next=35,yt.refresh_token(s);case 35:v.refreshToken=t.sent;case 36:return t.next=38,yt.createToken(y,s.two_factor_status?"clave":"clave_secreta");case 38:if(v.token=t.sent,1!==(null==f?void 0:f.id)||!s.two_factor_status){t.next=42;break}return t.next=42,e.sendEmailCode(s,f.id);case 42:return t.abrupt("return",n.status(_.HTTP_OK).json(v));case 43:case"end":return t.stop()}}),t)}))),function(e,t){return p.apply(this,arguments)})},{key:"sendCode",value:(d=R(S.mark((function t(r,n){var a,o;return S.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a=r.usuario.email,t.next=3,De.findOne({where:{email:a}});case 3:return o=t.sent,t.next=6,e.sendEmailCode(o,1);case 6:return t.abrupt("return",n.status(_.HTTP_OK).json({message:"Se ha enviado el codigo a su correo electrónico"}));case 7:case"end":return t.stop()}}),t)}))),function(e,t){return d.apply(this,arguments)})},{key:"sendEmailCode",value:(l=R(S.mark((function e(t,r){var n,a,o,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ne.findOne({where:{id_usuario:t.id,id_metodo:r},attributes:["secret_key"]});case 2:return n=e.sent,a=n.secret_key,o=L.totp({secret:a,encoding:"base32",window:Number(process.env.TIME_BASED_TOKEN_2FA),step:10}),i=[{tagName:"mj-button",attributes:{width:"80%",padding:"5px 10px","font-size":"20px","background-color":"#175efb","border-radius":"99px"},content:"El codigo de verificacion es:"}],e.next=8,Tt.sendMail({email:t.email,header:i,subject:"Codigo de verificacion de usuario",message:o});case 8:case"end":return e.stop()}}),e)}))),function(e,t){return l.apply(this,arguments)})},{key:"logout",value:(c=R(S.mark((function e(t,r){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,De.update({token_valid_after:K().tz("America/El_Salvador").format(),two_factor_status:!1},{where:{id:t.usuario.id}});case 2:return e.abrupt("return",r.status(_.HTTP_OK).json());case 3:case"end":return e.stop()}}),e)}))),function(e,t){return c.apply(this,arguments)})},{key:"twoFactorAuthLoginChoose",value:(u=R(S.mark((function e(t,r,n){var a,o,i,s,u,c,l,d,p;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=t.body.id_metodo,o=t.headers.authorization,i=o&&o.replace("Bearer ","")){e.next=5;break}throw new ht("No autenticado");case 5:return e.prev=5,s=D.verify(i,"clave"),u=s.user,e.next=9,Ne.findOne({where:{id_usuario:u.id,id_metodo:a,verified:!0}});case 9:if(c=e.sent,1!==a){e.next=18;break}return l=L.generateSecret({length:52}).base32,e.next=14,c.update({secret_key:l});case 14:return d=L.totp({secret:l,encoding:"base32",window:Number(process.env.TIME_BASED_TOKEN_2FA),step:10}),p=[{tagName:"mj-button",attributes:{width:"80%",padding:"5px 10px","font-size":"20px","background-color":"#175efb","border-radius":"99px"},content:"El codigo de verificacion es:"}],e.next=18,Tt.sendMail({email:u.email,header:p,subject:"Codigo de verificacion de usuario",message:d});case 18:return e.abrupt("return",r.status(_.HTTP_OK).send({message:"Se ha enviado el codigo de verificacion a su correo electronico"}));case 21:return e.prev=21,e.t0=e.catch(5),e.abrupt("return",P.handlerError(e.t0,t,r,n));case 24:case"end":return e.stop()}}),e,null,[[5,21]])}))),function(e,t,r){return u.apply(this,arguments)})},{key:"verifyTwoFactorAuthCode",value:(s=R(S.mark((function e(t,r){var n,a,o,i,s,u,c,l,d,p;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.body,a=n.code,o=n.id_method,i=t.usuario.id,e.next=4,De.findByPk(i);case 4:return s=e.sent,e.next=7,Ne.findOne({where:{id_usuario:s.id,id_metodo:o}});case 7:if(u=e.sent){e.next=10;break}throw new ht("Metodo de autenticación no configurado");case 10:if(null!=u&&u.verified){e.next=12;break}throw new ht("El metodo de autenticación no ha sido verificado");case 12:return c={code:a,secretKey:u.secret_key},1===u.id_metodo&&(c.time=process.env.TIME_BASED_TOKEN_2FA,c.step=10),e.next=16,qt.verifyTwoFactorAuthCode(c);case 16:if(e.sent){e.next=19;break}throw new St("El codigo proporcionado no es valido");case 19:return e.next=21,s.update({two_factor_status:!0,last_login:K().tz("America/El_Salvador").format(),token_valid_after:K().subtract(5,"s").tz("America/El_Salvador").format()});case 21:return e.next=23,Nt.roles(s.id);case 23:return l=e.sent,e.next=26,yt.refresh_token(s);case 26:return d=e.sent,e.next=29,yt.createToken({id:s.id,roles:l,user:s,email:s.email},"clave_secreta");case 29:return p=e.sent,e.abrupt("return",r.status(_.HTTP_OK).send({token:p,refreshToken:d,"2fa":s.two_factor_status}));case 31:case"end":return e.stop()}}),e)}))),function(e,t){return s.apply(this,arguments)})},{key:"RefreshToken",value:(i=R(S.mark((function e(t,r){var n,a,o,i,s,u,c,l;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Te.findOne({where:{refresh_token:t.body.refresh_token},attributes:["id","valid"],include:[{model:De,attributes:["id","email","last_login"]}]});case 2:if(n=e.sent){e.next=5;break}throw new ht;case 5:return e.next=7,Nt.roles(n.Usuario.id);case 7:if(a=e.sent,o=K(n.valid).valueOf(),i=K().tz("America/El_Salvador").valueOf(),!(o<i)){e.next=12;break}throw new ht("El refresh token porporcionado no es valido");case 12:return s=n.Usuario,u={id:s.id,email:s.email,last_login:s.last_login,two_factor_status:s.two_factor_status},e.next=16,yt.createToken({roles:a,user:u},"clave_secreta");case 16:return c=e.sent,e.next=19,yt.refresh_token(n.Usuario);case 19:return l=e.sent,e.next=22,n.update({valid:K().add("4","s").tz("America/El_Salvador").format()});case 22:return e.abrupt("return",r.status(_.HTTP_OK).json({token:c,refresh_token:l,user:n.Usuario}));case 23:case"end":return e.stop()}}),e)}))),function(e,t){return i.apply(this,arguments)})},{key:"resetPassword",value:(n=R(S.mark((function e(t,r){var n,a,o,i,s;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,De.findOne({where:{email:t.body.email,is_suspended:!1}});case 2:if(n=e.sent){e.next=5;break}throw new St("El parametro no es un correo valido");case 5:return e.next=7,yt.createToken({id:n.id,email:n.email},"clave_secreta");case 7:return a=e.sent,e.next=10,yt.refresh_token(n);case 10:return e.next=12,n.update({token_valid_after:K().tz("America/El_Salvador").format()},{where:{id:n.id}});case 12:return o="".concat("https://google.com","/reset-password/").concat(a),i=[{tagName:"mj-text",attributes:{align:"center","font-size":"30px","font-weight":"bold",color:"#175efb"},content:"Recuperación de Contraseña"},{tagName:"mj-spacer",attributes:{"css-class":"primary"}},{tagName:"mj-divider",attributes:{"border-width":"3px","border-color":"#175efb"}},{tagName:"mj-text",attributes:{align:"center","font-size":"18px"},children:[{tagName:"h3",content:"¿Una nueva contraseña?",children:[{tagName:"p",content:"Haz clic al siguiente boton y crea una nueva."}]}]}],s=[{tagName:"mj-column",attributes:{},children:[{tagName:"mj-button",attributes:{href:o,width:"80%",padding:"5px 10px","font-size":"20px","background-color":"#175efb","border-radius":"99px"},content:"Cambiar contraseña"},{tagName:"mj-text",attributes:{align:"justify"},children:[{tagName:"p",content:"Si no solicitaste el cambio de contraseña, ignora este correo. Tu contraseña continuará siendo la misma."}]}]}],e.next=17,Tt.sendMail({email:n.email,header:i,subject:"Restablecer Contraseña",sections:s});case 17:if(e.sent){e.next=19;break}throw new wt("Error! Hubo un problema al enviar el correo, intente nuevamente.");case 19:return e.abrupt("return",r.status(_.HTTP_OK).json({message:"El correo ha sido enviado"}));case 20:case"end":return e.stop()}}),e)}))),function(e,t){return n.apply(this,arguments)})},{key:"changePassword",value:(r=R(S.mark((function e(t,r){var n,a,o,i,s,u,c,l;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.body,a=n.password,o=n.confirm_password,i=t.headers.authorization.split(" ")[1],s=M.genSaltSync(),a===o){e.next=5;break}throw new wt("Error! Las contraseñas  no coinciden");case 5:return u=M.hashSync(a,s),c=D.verify(i,"clave_secreta"),l=c.id,e.next=9,De.update({password:u,token_valid_after:K().tz("America/El_Salvador").format()},{where:{id:l}});case 9:return e.abrupt("return",r.status(_.HTTP_OK).json({message:"contraseña actualizada"}));case 10:case"end":return e.stop()}}),e)}))),function(e,t){return r.apply(this,arguments)})},{key:"sendVerificationToken",value:(t=R(S.mark((function e(t,r){var n,a,o,i,s,u;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.body.email,e.next=3,De.findOne({where:{email:n}});case 3:return a=e.sent,o=a.id,e.next=7,yt.createToken({idUsuario:o},"clave_secreta");case 7:return i=e.sent,s=[{tagName:"mj-button",attributes:{width:"80%",padding:"5px 10px","font-size":"20px","background-color":"#175efb","border-radius":"99px"},content:"Hola ".concat(a.email)}],u=[{tagName:"mj-button",attributes:{width:"80%",padding:"5px 10px","font-size":"20px","background-color":"#175efb",href:"".concat("https://google.com","/verificar/").concat(i)},content:"VERIFICAR MI CUENTA"}],e.next=12,Tt.sendMail({email:a.email,header:s,subject:"Verificación de correo electrónico",message:"Para verificar tu cuenta debes de hacer click en el siguiente enlace:",body:u});case 12:return e.abrupt("return",r.status(_.HTTP_BAD_REQUEST).json({message:"Se ha reenviado el correo con el token de verificación"}));case 13:case"end":return e.stop()}}),e)}))),function(e,r){return t.apply(this,arguments)})}]);var t,r,n,i,s,u,c,l,d,p,f,m}();const zt=require("moment");var Mt=function(){var e=R(S.mark((function e(t,r,n){var a,o,i,s,u,c,l;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,a=t.headers.authorization){e.next=4;break}throw new ht;case 4:if(!((a=a.split(" ")).length<2)){e.next=7;break}throw new ht;case 7:return o=a[1],i=D.verify(o,"clave_secreta"),s=i.user,u=i.iat,c=1e3*u,e.next=12,De.findOne({where:{id:s.id,is_suspended:!1}});case 12:if(l=e.sent){e.next=15;break}throw new ht;case 15:if(!(zt(l.token_valid_after).valueOf()>c)){e.next=18;break}throw new ht;case 18:t.usuario=l,n(),e.next=25;break;case 22:e.prev=22,e.t0=e.catch(0),P.handlerError(e.t0,t,r,n);case 25:case"end":return e.stop()}}),e,null,[[0,22]])})));return function(t,r,n){return e.apply(this,arguments)}}();const Kt=Mt;var Dt=function(){var e=R(S.mark((function e(t,r,n){var a,o,i,s,u,c,l;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,a=t.headers.authorization){e.next=4;break}throw new ht;case 4:return o=a.replace("Bearer ",""),i=D.verify(o,"clave"),s=i.user,u=i.iat,c=1e3*u,e.next=9,De.findOne({where:{id:s.id,is_suspended:!1}});case 9:if(l=e.sent){e.next=12;break}throw new ht;case 12:if(!(zt(l.token_valid_after).valueOf()>c)){e.next=15;break}throw new ht;case 15:t.usuario=l,n(),e.next=22;break;case 19:e.prev=19,e.t0=e.catch(0),P.handlerError(e.t0,t,r,n);case 22:case"end":return e.stop()}}),e,null,[[0,19]])})));return function(t,r,n){return e.apply(this,arguments)}}();const Lt=Dt,Bt=function(e){return function(t,r,n){return e(t,r).catch((function(e){return n(e)}))}},Ht=require("@babel/runtime/helpers/slicedToArray"),Ut=require("qrcode");var Ct=function(){function e(){a(this,e)}return o(e,null,[{key:"exist",value:(i=R(S.mark((function t(r,n){var a,o,i,s,u=arguments;return S.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a=u.length>2&&void 0!==u[2]?u[2]:"Recurso no encontrado",o=u.length>3&&void 0!==u[3]?u[3]:{},i=e.isValid(n),t.next=5,r.findByPk(i,o);case 5:if(s=t.sent){t.next=8;break}throw new wt(a);case 8:return t.abrupt("return",s);case 9:case"end":return t.stop()}}),t)}))),function(e,t){return i.apply(this,arguments)})},{key:"isValid",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Unprocessable Entity by text";if(!(/^\d+$/.test(String(e))&&e>0))throw new St(t);return Number.parseInt(e,10)}},{key:"unique",value:(n=R(S.mark((function e(t,r){var n,a,o=arguments;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=o.length>2&&void 0!==o[2]?o[2]:"Debe ser un valor unico",e.next=3,t.findOne({where:r});case 3:if(!(a=e.sent)){e.next=6;break}throw new Pt(n);case 6:return e.abrupt("return",a);case 7:case"end":return e.stop()}}),e)}))),function(e,t){return n.apply(this,arguments)})},{key:"existOrCreate",value:(r=R(S.mark((function e(t,r,n){var a,o,i=arguments;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=i.length>3&&void 0!==i[3]?i[3]:null,e.next=3,t.findOne(r);case 3:if(o=e.sent){e.next=14;break}if(null===a){e.next=11;break}return e.next=8,t.create(n,a);case 8:o=e.sent,e.next=14;break;case 11:return e.next=13,t.create(n);case 13:o=e.sent;case 14:return e.abrupt("return",o);case 15:case"end":return e.stop()}}),e)}))),function(e,t,n){return r.apply(this,arguments)})},{key:"arrayExist",value:(t=R(S.mark((function e(t,r){var n,a,o,i=arguments;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=i.length>2&&void 0!==i[2]?i[2]:"id no existe",a=i.length>3&&void 0!==i[3]?i[3]:{},o=0;case 3:if(!(o<r.length)){e.next=9;break}return e.next=6,this.exist(t,r[o],n,a);case 6:o+=1,e.next=3;break;case 9:case"end":return e.stop()}}),e,this)}))),function(e,r){return t.apply(this,arguments)})}]);var t,r,n,i}();function Gt(e,t,r){return t=g(t),w(e,$t()?Reflect.construct(t,r||[],g(e).constructor):t.apply(e,r))}function $t(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return($t=function(){return!!e})()}var Ft=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Accion denegada";return a(this,t),Gt(this,t,["FORBIDDEN",_.HTTP_FORBIDDEN,e])}return x(t,e),o(t)}(T);function Vt(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Yt(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Vt(Object(r),!0).forEach((function(t){b(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Vt(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var Zt=function(){return o((function e(){a(this,e)}),null,[{key:"index",value:(p=R(S.mark((function e(t,r){var n,a,o,i,s,u,c,l,d,p,f,m,h,v;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.query,a=n.page,o=void 0===a?1:a,i=n.per_page,s=void 0===i?10:i,u=n.paginacion,c=void 0===u?"true":u,l=n.email,d=n.habilitado,p={},f={},"true"!==c){e.next=11;break}return e.next=6,Ct.isValid(s,"cantidad por pagina debe ser de tipo entero");case 6:return e.next=8,Ct.isValid(o,"pagina debe ser de tipo entero");case 8:f.offset=s*(o-1),f.limit=Number(s),f.distinct=!0;case 11:return l&&(p.email=b({},B.Op.iLike,"%".concat(l||"","%"))),d&&(p.is_suspended=!("true"===d)),e.next=15,De.findAndCountAll(Yt(Yt({},f),{},{attributes:{exclude:["password","token_valid_after","two_factor_status"]},include:[{model:we,through:{attributes:[]}},{model:ue,through:{attributes:[]}}],order:["id"],where:p}));case 15:return m=e.sent,h=m.rows,v=m.count,"true"===c&&r.set({total_rows:Number(v),page:Number(o),per_page:Number(s)}),e.abrupt("return",r.status(_.HTTP_OK).json(h));case 20:case"end":return e.stop()}}),e)}))),function(e,t){return p.apply(this,arguments)})},{key:"store",value:(d=R(S.mark((function e(t,r){var n,a,o,i,s,u,c,l,d,p,f,m,h,v,y,b,w,g;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=U.connection(),e.next=3,n.transaction();case 3:return a=e.sent,o=t.body,i=o.perfiles,s=o.roles,u=o.email,c=o.password,l="false"===process.env.DISABLE_TWO_FACTOR_AUTH,d=M.genSaltSync(),p=M.hashSync(c,d),e.next=10,De.findOne({where:{email:u}});case 10:if(!e.sent){e.next=13;break}throw new St("Correo electronico ya existe");case 13:if(e.prev=13,!i){e.next=25;break}h=0;case 16:if(!(h<i.length)){e.next=22;break}return e.next=19,Ct.exist(ue,i[h],"No se ha encontrado el perfil con id ".concat(i[h]));case 19:h++,e.next=16;break;case 22:return e.next=24,ue.findAll({where:{id:i}});case 24:m=e.sent;case 25:if(!s){e.next=36;break}v=0;case 27:if(!(v<s.length)){e.next=33;break}return e.next=30,Ct.exist(we,s[v],"No se ha encontrado el rol con id ".concat(s[v]));case 30:v++,e.next=27;break;case 33:return e.next=35,we.findAll({where:{id:s}});case 35:f=e.sent;case 36:return e.next=38,De.create({email:u,password:p,is_suspended:l,two_factor_status:!1,verified:!0},{transaction:a});case 38:return y=e.sent,e.next=41,i.forEach(function(){var e=R(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ee.create({id_usuario:y.id,id_perfil:t},{transaction:a});case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 41:return b=y.id,e.next=44,qt.generateTwoFactorAuthCode(y.email);case 44:return w=e.sent,e.next=47,Ne.create({id_usuario:y.id,id_metodo:1,is_primary:!0,secret_key:w.secret_code,verified:!0},{transaction:a});case 47:return e.next=49,yt.createToken({idUsuario:b},"clave_secreta");case 49:return g=e.sent,"Hola ".concat(y.email),"".concat("https://google.com","/verificar/").concat(g),e.next=54,a.commit();case 54:return e.abrupt("return",r.status(_.HTTP_CREATED).json({id:y.id,email:y.email,perfiles:m,roles:f}));case 57:return e.prev=57,e.t0=e.catch(13),e.next=61,a.rollback();case 61:throw e.t0;case 62:case"end":return e.stop()}}),e,null,[[13,57]])}))),function(e,t){return d.apply(this,arguments)})},{key:"update",value:(l=R(S.mark((function e(t,r){var n,a,o,i,s,u,c,l;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.body,a=n.email,o=n.roles,i=void 0===o?[]:o,s=n.perfiles,u=void 0===s?[]:s,c={},null!==a&&""!==a&&(c.email=a),e.next=5,Ct.exist(De,t.params.id,"No se ha encontrado el usuario con id ".concat(t.params.id));case 5:return(l=e.sent).update(c,{where:{id:t.params.id},returning:["id","email","is_suspended"]}),e.next=9,l.setRols(i);case 9:return e.next=11,l.setPerfils(u);case 11:return e.abrupt("return",r.status(_.HTTP_OK).json(l));case 12:case"end":return e.stop()}}),e)}))),function(e,t){return l.apply(this,arguments)})},{key:"destroy",value:(c=R(S.mark((function e(t,r){var n,a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.params.id,e.next=3,Ct.exist(De,n,"No se ha encontrado el usuario con id ".concat(n));case 3:return a=e.sent,e.next=6,a.update({is_suspended:!a.is_suspended});case 6:return e.abrupt("return",r.status(_.HTTP_OK).json({message:a.is_suspended?"Usuario deshabilitado":"Usuario habilitado"}));case 7:case"end":return e.stop()}}),e)}))),function(e,t){return c.apply(this,arguments)})},{key:"show",value:(u=R(S.mark((function e(t,r){var n,a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.params.id,e.next=3,Ct.exist(De,n,"No se ha encontrado el usuario con id ".concat(n),{include:[{model:ue,through:{attributes:[]}},{model:we,through:{attributes:[]}}]});case 3:a=e.sent,r.status(_.HTTP_OK).json(a);case 5:case"end":return e.stop()}}),e)}))),function(e,t){return u.apply(this,arguments)})},{key:"updatePassword",value:(s=R(S.mark((function e(t,r){var n,a,o,i,s,u,c,l,d,p;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.body,a=n.password_actual,o=n.password,i=n.confirm_password,M.compareSync(a,t.usuario.password)){e.next=3;break}throw new Ft("La contraseña proporcionada no es correcta");case 3:if(a!==o){e.next=5;break}throw new wt("La nueva contraseña no puede ser igual que la anterior");case 5:if(o===i){e.next=7;break}throw new Pt("Las contraseñas no coinciden");case 7:return s=M.genSaltSync(),u=M.hashSync(o,s),e.next=11,De.update({password:u,token_valid_after:K().subtract(5,"s").tz("America/El_Salvador").format()},{where:{id:t.usuario.id}});case 11:return c=[],e.next=14,Tt.sendMail({email:t.usuario.email,header:c,subject:"Cambio de contraseña",message:"Constraseña modificada"});case 14:return e.next=16,yt.refresh_token(t.usuario);case 16:return l=e.sent,e.next=19,Nt.roles(t.usuario.id);case 19:return d=e.sent,e.next=22,yt.createToken({roles:d,user:t.usuario},"clave_secreta");case 22:return p=e.sent,e.abrupt("return",r.status(_.HTTP_OK).json({message:"Contraseña actualizada con exito",token:p,refreshToken:l}));case 24:case"end":return e.stop()}}),e)}))),function(e,t){return s.apply(this,arguments)})},{key:"updateEmail",value:(i=R(S.mark((function e(t,r){var n,a,o,i,s,u,c,l;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.body,a=n.email,o=n.password,a!==t.usuario.email){e.next=3;break}throw new St("El correo no puede ser igual al anterior");case 3:if(M.compareSync(o,t.usuario.password)){e.next=5;break}throw new Pt("La contraseña proporcionada no es correcta");case 5:return e.next=7,De.findOne({where:{email:a}});case 7:if(!e.sent){e.next=10;break}throw new wt("El correo ya se encuentra en uso");case 10:return i="\n      Estimado usuario se le comunica que el correo: ".concat(t.usuario.email,"\n        ha sido cambiado satisfactoriamente.\n        Desde este momento ").concat(a,"\n    manejará la cuenta en donde solicito el cambio"),e.next=13,Tt.sendMail({email:a,header:[],message:i,subject:"Cambio de email"});case 13:return e.next=15,De.findOne({where:{id:t.usuario.id},attributes:["id","email","last_login","two_factor_status"]});case 15:return s=e.sent,e.next=18,s.update({email:a,token_valid_after:K().tz("America/El_Salvador").format()},{returning:!0});case 18:return e.next=20,yt.refresh_token(t.usuario);case 20:return u=e.sent,e.next=23,Nt.roles(t.usuario.id);case 23:return c=e.sent,e.next=26,yt.createToken({roles:c,user:s},"clave_secreta");case 26:return l=e.sent,e.abrupt("return",r.status(_.HTTP_OK).json({message:"Correo electronico actualizado con exito",token:l,refreshToken:u}));case 28:case"end":return e.stop()}}),e)}))),function(e,t){return i.apply(this,arguments)})},{key:"storeMethodUser",value:(n=R(S.mark((function e(t,r){var n,a,o,i,s,u,c,l;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.body.id_method,e.next=3,qt.generateTwoFactorAuthCode(t.usuario.email);case 3:return a=e.sent,o={is_primary:!1,temporal_key:a.secret_code,verified:!1},e.next=7,Ne.findOrCreate({where:{id_usuario:t.usuario.id,id_metodo:n},defaults:o});case 7:if(i=e.sent,s=Ht(i,2),u=s[0],s[1]){e.next=14;break}return e.next=14,u.update({temporal_key:a.secret_code});case 14:if(2!==Number(n)){e.next=21;break}return e.t0=r.status(_.HTTP_OK),e.next=18,(0,Ut.toDataURL)(a.qrCode);case 18:return e.t1=e.sent,e.t2={message:"Favor valide el nuevo metodo de autenticacion, escanee el codigo qr",codigoQr:e.t1},e.abrupt("return",e.t0.send.call(e.t0,e.t2));case 21:return c=L.totp({secret:u.temporal_key,encoding:"base32",window:Number(process.env.TIME_BASED_TOKEN_2FA),step:10}),l=[{tagName:"mj-button",attributes:{width:"80%",padding:"5px 10px","font-size":"20px","background-color":"#175efb","border-radius":"99px"},content:"El codigo de verificacion es:"}],e.next=25,Tt.sendMail({email:t.usuario.email,header:l,subject:"Codigo de verificación de usuario",message:c});case 25:return e.abrupt("return",r.status(_.HTTP_OK).send({message:"Favor valide el nuevo metodo de autenticación, revise su correo electrónico"}));case 26:case"end":return e.stop()}}),e)}))),function(e,t){return n.apply(this,arguments)})},{key:"authMethodVerification",value:(r=R(S.mark((function e(t,r){var n,a,o,i,s,u;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.body,a=n.id_method,o=n.code,e.next=3,Ne.findOne({where:{id_usuario:t.usuario.id,id_metodo:a}});case 3:if(i=e.sent){e.next=6;break}throw new wt("El usuario no tiene este metodo de autenticacion asociado");case 6:return s={code:o,secretKey:i.temporal_key},1===Number(a)&&(s.time=process.env.TIME_BASED_TOKEN_2FA),e.next=10,qt.verifyTwoFactorAuthCode(s);case 10:if(e.sent){e.next=13;break}throw new St("El codigo proporcionado no es valido");case 13:return e.next=15,i.update({secret_key:i.temporal_key,verified:!0});case 15:return u=[{tagName:"mj-text",attributes:{width:"80%",padding:"5px 10px","font-size":"20px","background-color":"#175efb","border-radius":"99px"},content:"Se ha cambiado el metodo de autenticación"}],e.next=18,Tt.sendMail({email:t.usuario.email,subject:"Metodo de autenticacion cambiado.",header:u});case 18:return e.abrupt("return",r.status(_.HTTP_OK).send({message:"Se ha modificado el metodo de autenticación con exito!"}));case 19:case"end":return e.stop()}}),e)}))),function(e,t){return r.apply(this,arguments)})},{key:"updatePrimaryMethod",value:(t=R(S.mark((function e(t,r){var n,a,o,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.params.id_method,a=t.usuario.id,e.next=4,Ne.findOne({where:{id_usuario:a,id_metodo:n}});case 4:if(null!=(o=e.sent)&&o.verified){e.next=7;break}throw new St("No es posible seleccionar este método de autenticación debido a que no esta verificado");case 7:return e.next=9,Ne.update({is_primary:!1},{where:{id:b({},B.Op.not,o.id),id_usuario:t.usuario.id}});case 9:return e.next=11,o.update({is_primary:!0});case 11:return i=[{tagName:"mj-text",attributes:{width:"80%",padding:"5px 10px","font-size":"20px","background-color":"#175efb","border-radius":"99px"},content:"Se ha cambiado el método de autenticación primario"}],e.next=14,Tt.sendMail({email:t.usuario.email,subject:"Alerta de actualización de cuenta.",header:i});case 14:return e.abrupt("return",r.status(_.HTTP_OK).send({message:"Solicitud procesada con exito!"}));case 15:case"end":return e.stop()}}),e)}))),function(e,r){return t.apply(this,arguments)})},{key:"getMetodosUsuario",value:(e=R(S.mark((function e(t,r){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Pe.findAll({include:[{model:Ne,required:!1,where:{id_usuario:t.usuario.id}}]});case 2:return n=e.sent,e.abrupt("return",r.status(_.HTTP_OK).json(n));case 4:case"end":return e.stop()}}),e)}))),function(t,r){return e.apply(this,arguments)})}]);var e,t,r,n,i,s,u,c,l,d,p}();const Qt=function(e){return function(){var t=R(S.mark((function t(r,n,a){return S.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,qt.isGranted(r.usuario.id,e);case 2:t.sent?a():P.handlerError(new Ft,r,n,a);case 4:case"end":return t.stop()}}),t)})));return function(e,r,n){return t.apply(this,arguments)}}()};var Jt=(0,l.Router)();Jt.get("/2fa/method",[Qt("ROLE_USER_AUTH_METHOD_LIST")],Bt(Zt.getMetodosUsuario)),Jt.get("/",[Qt("ROLE_USER_LIST")],Bt(Zt.index)),Jt.post("/",[Qt("ROLE_USER_CREATE"),z({$id:"http://example.com/schemas/usuarioCreateSchema.json#",type:"object",properties:{password:{$ref:"defs.json#/definitions/password"},email:{$ref:"defs.json#/definitions/email"},perfiles:{$ref:"defs.json#/definitions/arrayIntUnico"},roles:{$ref:"defs.json#/definitions/arrayIntUnico"}},anyOf:[{required:["roles"],errorMessage:{required:"Debe poseer un rol o un pefil"}},{required:["perfiles"],errorMessage:{required:"Debe poseer un rol o un pefil"}}],required:["password","email"],errorMessage:{required:{password:"El campo de contraseña del usuario es requerido",email:"El campo de email del usuario es requerido"},properties:{perfiles:"El campo perfiles debe de ser un array de valores unicos y tipo numerico",roles:"El campo roles debe de ser un array de valores unicos y tipo numerico"}}})],Bt(Zt.store)),Jt.get("/:id",[Qt("ROLE_USER_LIST")],Bt(Zt.show)),Jt.put("/:id",[Qt("ROLE_USER_UPDATE"),z({$id:"http://example.com/schemas/usuarioUpdateSchema.json#",type:"object",properties:{email:{$ref:"defs.json#/definitions/email"},perfiles:{$ref:"defs.json#/definitions/arrayIntUnico"},roles:{$ref:"defs.json#/definitions/arrayIntUnico"}},anyOf:[{required:["roles"],errorMessage:{required:"Debe poseer un rol o un pefil"}},{required:["perfiles"],errorMessage:{required:"Debe poseer un rol o un pefil"}}],required:["email"],errorMessage:{required:{email:"El campo de email del usuario es requerido"},properties:{perfiles:"El campo perfiles debe de ser un array de valores unicos y tipo numerico",roles:"El campo roles debe de ser un array de valores unicos y tipo numerico"}}})],Bt(Zt.update)),Jt.delete("/:id",[Qt("ROLE_USER_DELETE")],Bt(Zt.destroy)),Jt.put("/update/password",[z({$id:"http://example.com/schemas/usuarioPasswordUpdate.json#",type:"object",properties:{password_actual:{$ref:"defs.json#/definitions/string"},password:{$ref:"defs.json#/definitions/password"},confirm_password:{$ref:"defs.json#/definitions/password"}},required:["password_actual","password","confirm_password"],errorMessage:{required:{password_actual:"La contraseña actual es requerida",password:"Debe proporcionar una nueva contraseña",confirm_password:"Debe confirmar la contraseña"}}})],Bt(Zt.updatePassword)),Jt.put("/update/email",[z({$id:"http://example.com/schemas/usuarioUpdateEmailSchema.json#",type:"object",properties:{email:{$ref:"defs.json#/definitions/email"},password:{$ref:"defs.json#/definitions/string"}},required:["email","password"],errorMessage:{required:{email:"El campo email de la ruta es requerido",password:"El campo password de la ruta es requerido"}}})],Bt(Zt.updateEmail)),Jt.post("/2fa/method",Bt(Zt.storeMethodUser)),Jt.post("/2fa/method/verify",Bt(Zt.authMethodVerification)),Jt.put("/2fa/method/:id_method",Bt(Zt.updatePrimaryMethod));const Wt=Jt;function Xt(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function er(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Xt(Object(r),!0).forEach((function(t){b(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Xt(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var tr=function(){return o((function e(){a(this,e)}),null,[{key:"index",value:(i=R(S.mark((function e(t,r){var n,a,o,i,s,u,c,l,d,p,f,m,h;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.query,a=n.page,o=void 0===a?1:a,i=n.per_page,s=void 0===i?10:i,u=n.paginacion,c=void 0===u?"true":u,l=n.nombre,d={},p={},"true"!==c){e.next=11;break}return e.next=6,Ct.isValid(s,"cantidad por pagina debe ser de tipo entero");case 6:return e.next=8,Ct.isValid(o,"pagina debe ser de tipo entero");case 8:p.offset=s*(o-1),p.limit=Number(s),p.distinct=!0;case 11:return l&&(d.name=b({},B.Op.iLike,"%".concat(l,"%"))),e.next=14,we.findAndCountAll(er({include:[{model:ve}],where:d},p));case 14:return f=e.sent,m=f.count,h=f.rows,"true"===c&&r.set({total_rows:Number(m),page:Number(o),per_page:Number(s)}),e.abrupt("return",r.status(_.HTTP_OK).json(h));case 19:case"end":return e.stop()}}),e)}))),function(e,t){return i.apply(this,arguments)})},{key:"store",value:(n=R(S.mark((function e(t,r){var n,a,o,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.body,a=n.name,o=n.id_tipo_rol,e.next=3,we.findOne({where:{name:a.trim().toUpperCase()}});case 3:if(!e.sent){e.next=6;break}throw new St("Role ya existe");case 6:return e.next=8,we.create({name:a.trim().toUpperCase(),id_tipo_rol:o});case 8:return i=e.sent,e.abrupt("return",r.status(_.HTTP_CREATED).json(i));case 10:case"end":return e.stop()}}),e)}))),function(e,t){return n.apply(this,arguments)})},{key:"show",value:(r=R(S.mark((function e(t,r){var n,a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.params.id,e.next=3,Ct.exist(we,n,"El rol no ha sido encontrado");case 3:return a=e.sent,e.abrupt("return",r.status(_.HTTP_OK).json(a));case 5:case"end":return e.stop()}}),e)}))),function(e,t){return r.apply(this,arguments)})},{key:"update",value:(t=R(S.mark((function e(t,r){var n,a,o,i,s;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.body,a=n.name,o=n.id_tipo_rol,i=t.params.id,e.next=4,Ct.exist(we,i,"El rol no ha sido encontrado");case 4:return e.next=6,we.update({name:a,id_tipo_rol:o},{where:{id:i},returning:["name","id_tipo_rol"]});case 6:return s=e.sent,e.abrupt("return",r.status(_.HTTP_OK).json(s[1]));case 8:case"end":return e.stop()}}),e)}))),function(e,r){return t.apply(this,arguments)})},{key:"destroy",value:(e=R(S.mark((function e(t,r){var n,a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.params.id,e.next=3,Ct.exist(we,n,"El rol no ha sido encontrado");case 3:return a=e.sent,e.next=6,a.destroy();case 6:return e.abrupt("return",r.status(_.HTTP_OK).json({message:"Rol eliminado"}));case 7:case"end":return e.stop()}}),e)}))),function(t,r){return e.apply(this,arguments)})}]);var e,t,r,n,i}();const rr={$id:"http://example.com/schemas/rolCreateSchema.json#",type:"object",properties:{id_tipo_rol:{$ref:"defs.json#/definitions/integer"}},required:["id_tipo_rol"],errorMessage:{properties:{id_tipo_rol:"El campo id_tipo_rol debe ser de tipo numérico"}},allOf:[{if:{properties:{id_tipo_rol:{const:1}}},then:{properties:{name:{type:"string",pattern:"^(ROLE_)+[A-Z_]*",errorMessage:{type:"el name debe ser de tipo alfanumerico",pattern:"el name debe tener el prefijo ROLE_"}}}}},{if:{properties:{id_tipo_rol:{const:2}}},then:{properties:{name:{type:"string",pattern:"^(ROLE_ADMIN_)+[A-Z_]*",errorMessage:{type:"el name debe ser de tipo alfanumerico",pattern:"el name debe tener el prefijo ROLE_ADMIN_"}}}}},{if:{properties:{id_tipo_rol:{const:3}}},then:{properties:{name:{type:"string",pattern:"^(ROLE_FRONT_)+[A-Z_]*",errorMessage:{type:"el name debe ser de tipo alfanumerico",pattern:"el name debe tener el prefijo ROLE_FRONT_"}}}}}]};var nr=(0,l.Router)();nr.get("/",[Qt("ROLE_ROLE_LIST")],Bt(tr.index)),nr.post("/",[z(rr),Qt("ROLE_ROLE_CREATE")],Bt(tr.store)),nr.get("/:id",[Qt("ROLE_ROLE_LIST")],Bt(tr.show)),nr.put("/:id",[z(rr),Qt("ROLE_ROLE_UPDATE")],Bt(tr.update)),nr.delete("/:id",[Qt("ROLE_ROLE_DELETE")],Bt(tr.destroy));const ar=nr;var or=function(){return o((function e(){a(this,e)}),null,[{key:"index",value:(e=R(S.mark((function e(t,r){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ve.findAll();case 2:return n=e.sent,e.abrupt("return",r.status(_.HTTP_OK).json(n));case 4:case"end":return e.stop()}}),e)}))),function(t,r){return e.apply(this,arguments)})}]);var e}(),ir=(0,l.Router)();ir.get("/",[],Bt(or.index));const sr=ir;function ur(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function cr(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ur(Object(r),!0).forEach((function(t){b(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ur(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var lr=function(){return o((function e(){a(this,e)}),null,[{key:"index",value:(n=R(S.mark((function e(t,r){var n,a,o,i,s,u,c,l,d,p,f,m,h,v;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.query,a=n.page,o=void 0===a?1:a,i=n.per_page,s=void 0===i?10:i,u=n.paginacion,c=void 0===u?"true":u,l=n.nombre,d=n.codigo,p={},f={},"true"!==c){e.next=11;break}return e.next=6,Ct.isValid(s,"cantidad por pagina debe ser de tipo entero");case 6:return e.next=8,Ct.isValid(o,"pagina debe ser de tipo entero");case 8:f.offset=s*(o-1),f.limit=Number(s),f.distinct=!0;case 11:return l&&(p.nombre=b({},B.Op.iLike,"%".concat(l,"%"))),d&&(p.codigo=b({},B.Op.iLike,"%".concat(d,"%"))),e.next=15,ue.findAndCountAll(cr({include:[{model:we,required:!0}],where:p},f));case 15:return m=e.sent,h=m.count,v=m.rows,"true"===c&&r.set({total_rows:Number(h),page:Number(o),per_page:Number(s)}),e.abrupt("return",r.status(_.HTTP_OK).json(v));case 20:case"end":return e.stop()}}),e)}))),function(e,t){return n.apply(this,arguments)})},{key:"store",value:(r=R(S.mark((function e(t,r){var n,a,o,i,s,u;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.body,a=n.nombre,o=n.codigo,i=n.roles,e.next=3,U.connection().transaction();case 3:return s=e.sent,e.prev=4,e.next=7,ue.create({nombre:a,codigo:o},{transaction:s});case 7:return u=e.sent,e.next=10,u.setRols(i,{transaction:s});case 10:return e.next=12,s.commit();case 12:return e.abrupt("return",r.status(_.HTTP_CREATED).json({id:u.id,nombre:a,codigo:o,roles:i}));case 15:return e.prev=15,e.t0=e.catch(4),e.next=19,s.rollback();case 19:throw e.t0;case 20:case"end":return e.stop()}}),e,null,[[4,15]])}))),function(e,t){return r.apply(this,arguments)})},{key:"show",value:(t=R(S.mark((function e(t,r){var n,a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.params.id,e.next=3,Ct.exist(ue,n,"El perfil no ha sido encontrado",{include:{model:we,through:{attributes:[]}}});case 3:return a=e.sent,e.abrupt("return",r.status(_.HTTP_OK).json(a));case 5:case"end":return e.stop()}}),e)}))),function(e,r){return t.apply(this,arguments)})},{key:"update",value:(e=R(S.mark((function e(t,r){var n,a,o,i,s,u,c;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.body,a=n.nombre,o=n.codigo,i=n.roles,s=t.params.id,e.next=4,U.connection().transaction();case 4:return u=e.sent,e.prev=5,e.next=8,Ct.exist(ue,s,"Perfil no encontrado");case 8:return c=e.sent,e.next=11,c.update({nombre:a,codigo:o},{transaction:u});case 11:return e.next=13,c.setRols(i,{transaction:u});case 13:return e.next=15,u.commit();case 15:return e.abrupt("return",r.status(_.HTTP_OK).json(c));case 18:return e.prev=18,e.t0=e.catch(5),e.next=22,u.rollback();case 22:throw e.t0;case 23:case"end":return e.stop()}}),e,null,[[5,18]])}))),function(t,r){return e.apply(this,arguments)})}]);var e,t,r,n}();var dr=(0,l.Router)();dr.get("/",[Qt("ROLE_PROFILE_LIST")],Bt(lr.index)),dr.post("/",[Qt("ROLE_PROFILE_CREATE"),z({$id:"http://example.com/schemas/perfilCreateSchema.json#",type:"object",properties:{nombre:{$ref:"defs.json#/definitions/string"},codigo:{$ref:"defs.json#/definitions/codigo"},roles:{$ref:"defs.json#/definitions/arrayIntUnico"}},required:["nombre","codigo","roles"],errorMessage:{required:{nombre:"El nombre es requerido",codigo:"El código es requerido",roles:"El campo roles es requerido"},properties:{nombre:"el nombre debe ser de tipo alfanumerico",roles:"Los roles deber ser un array numerico"}}})],Bt(lr.store)),dr.get("/:id",[Qt("ROLE_PROFILE_LIST")],Bt(lr.show)),dr.put("/:id",[Qt("ROLE_PROFILE_UPDATE"),z({$id:"http://example.com/schemas/perfilUpdateSchema.json#",type:"object",properties:{nombre:{$ref:"defs.json#/definitions/string"},codigo:{$ref:"defs.json#/definitions/codigo"}},required:["nombre","codigo"],errorMessage:{required:{nombre:"El campo nombre es requerido",codigo:"El campo codigo es requerido"},properties:{nombre:"el nombre debe ser de tipo alfanumerico"}}})],Bt(lr.update));const pr=dr;var fr;function mr(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function hr(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?mr(Object(r),!0).forEach((function(t){b(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):mr(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function vr(e){var t,r,n,a=2;for("undefined"!=typeof Symbol&&(r=Symbol.asyncIterator,n=Symbol.iterator);a--;){if(r&&null!=(t=e[r]))return t.call(e);if(n&&null!=(t=e[n]))return new yr(t.call(e));r="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function yr(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then((function(e){return{value:e,done:t}}))}return yr=function(e){this.s=e,this.n=e.next},yr.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var r=this.s.return;return void 0===r?Promise.resolve({value:e,done:!0}):t(r.apply(this.s,arguments))},throw:function(e){var r=this.s.return;return void 0===r?Promise.reject(e):t(r.apply(this.s,arguments))}},new yr(e)}var br=function(){function e(){a(this,e)}return o(e,null,[{key:"index",value:(s=R(S.mark((function e(t,r){var n,a,o,i,s,u,c,l,d,p,f,m,h,v;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.query,a=n.page,o=void 0===a?1:a,i=n.per_page,s=void 0===i?10:i,u=n.paginacion,c=void 0===u?"true":u,l=n.nombre,d=n.uri,p={},f={},"true"!==c){e.next=11;break}return e.next=6,Ct.isValid(s,"cantidad por pagina debe ser de tipo entero");case 6:return e.next=8,Ct.isValid(o,"pagina debe ser de tipo entero");case 8:f.offset=s*(o-1),f.limit=Number(s),f.distinct=!0;case 11:return l&&(p.nombre=b({},B.Op.iLike,"%".concat(l,"%"))),d&&(p.uri=b({},B.Op.iLike,"%".concat(d,"%"))),e.next=15,Q.findAndCountAll(hr({include:[{model:we}],where:p},f));case 15:return m=e.sent,h=m.count,v=m.rows,"true"===c&&r.set({total_rows:Number(h),page:Number(o),per_page:Number(s)}),e.abrupt("return",r.status(_.HTTP_OK).json(v));case 20:case"end":return e.stop()}}),e)}))),function(e,t){return s.apply(this,arguments)})},{key:"store",value:(i=R(S.mark((function e(t,r){var n,a,o,i,s,u,c,l,d,p,f,m,h,v,y,b,w,g;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=U.connection(),e.next=3,n.transaction();case 3:if(a=e.sent,o=t.body,i=o.nombre,s=o.uri,u=o.nombre_uri,c=o.mostrar,l=o.icono,d=o.orden,p=o.admin,f=o.publico,m=o.id_ruta_padre,h=o.roles,e.prev=5,!h){e.next=14;break}v=0;case 8:if(!(v<h.length)){e.next=14;break}return e.next=11,Ct.exist(we,h[v],"No se encontró el rol con id ".concat(h[v]));case 11:v++,e.next=8;break;case 14:return e.next=16,Q.create({nombre:i,uri:s,nombre_uri:u,mostrar:c,icono:l,orden:d,admin:p,publico:f,id_ruta_padre:m},{transaction:a});case 16:return y=e.sent,e.next=19,y.addRols(h,{transaction:a});case 19:return e.next=21,a.commit();case 21:return b=y.id,e.next=24,Q.getById(b,{include:[{model:we}]});case 24:return w=e.sent,g=w.Rols,e.abrupt("return",r.status(_.HTTP_CREATED).json({id:y.id,nombre:y.nombre,nombre_uri:y.nombre_uri,mostrar:y.mostrar,icono:y.icono,orden:y.orden,admin:y.admin,publico:y.publico,id_ruta_padre:y.id_ruta_padre,roles:g}));case 29:return e.prev=29,e.t0=e.catch(5),e.next=33,a.rollback();case 33:throw e.t0;case 34:case"end":return e.stop()}}),e,null,[[5,29]])}))),function(e,t){return i.apply(this,arguments)})},{key:"show",value:(n=R(S.mark((function e(t,r){var n,a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.params.id,e.next=3,Ct.exist(Q,n,"No se encontró una ruta con id ".concat(n),{include:{model:we,attributes:["id","name"]}});case 3:return a=e.sent,e.abrupt("return",r.status(_.HTTP_OK).json(a.dataValues));case 5:case"end":return e.stop()}}),e)}))),function(e,t){return n.apply(this,arguments)})},{key:"update",value:(r=R(S.mark((function e(t,r){var n,a,o,i,s,u,c,l,d,p,f,m,h;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.body,a=n.nombre,o=n.uri,i=n.nombre_uri,s=n.mostrar,u=n.icono,c=n.orden,l=n.admin,d=n.publico,p=n.id_ruta_padre,f=n.roles,m=t.params.id,e.next=4,Ct.exist(Q,m,"No se encontró una ruta con id ".concat(m));case 4:return h=e.sent,e.next=7,h.update({nombre:a,uri:o,nombre_uri:i,mostrar:s,icono:u,orden:c,admin:l,publico:d,id_ruta_padre:p});case 7:return e.next=9,h.setRols(f);case 9:return e.abrupt("return",r.status(_.HTTP_OK).json({message:"Datos actualizados con exito"}));case 10:case"end":return e.stop()}}),e)}))),function(e,t){return r.apply(this,arguments)})},{key:"getRutas",value:(t=R(S.mark((function t(r,n){var a,o;return S.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a="http://localhost:8080||http://localhost:8081".split("||"),t.next=3,_r.call(e,r.usuario.id,a.includes(r.headers.origin));case 3:return o=t.sent,t.abrupt("return",n.status(_.HTTP_OK).json(o));case 5:case"end":return t.stop()}}),t)}))),function(e,r){return t.apply(this,arguments)})}]);var t,r,n,i,s}();function _r(e,t){return wr.apply(this,arguments)}function wr(){return(wr=R(S.mark((function e(t,r){var n,a,o;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Nt.roles(t,"id");case 2:return n=e.sent,e.next=5,Q.findAll({attributes:["id","nombre","uri","nombre_uri","icono","mostrar","orden","id_ruta_padre"],include:[{model:we,where:{id:n},attributes:[]}],where:{id_ruta_padre:null,admin:r},order:["orden"]});case 5:return a=e.sent,e.next=8,gr.call(fr,a);case 8:return o=e.sent,e.abrupt("return",o);case 10:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function gr(e){return xr.apply(this,arguments)}function xr(){return xr=R(S.mark((function e(t){var r,n,a,o,i,s;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=!1,n=!1,e.prev=2,o=vr(t);case 4:return e.next=6,o.next();case 6:if(!(r=!(i=e.sent).done)){e.next=17;break}return s=i.value,e.next=10,kr.call(fr,s.id);case 10:if(s.rutas=e.sent,!s.rutas){e.next=14;break}return e.next=14,gr.call(fr,s.rutas);case 14:r=!1,e.next=4;break;case 17:e.next=23;break;case 19:e.prev=19,e.t0=e.catch(2),n=!0,a=e.t0;case 23:if(e.prev=23,e.prev=24,!r||null==o.return){e.next=28;break}return e.next=28,o.return();case 28:if(e.prev=28,!n){e.next=31;break}throw a;case 31:return e.finish(28);case 32:return e.finish(23);case 33:return e.abrupt("return",t);case 34:case"end":return e.stop()}}),e,null,[[2,19,23,33],[24,,28,32]])}))),xr.apply(this,arguments)}function kr(e){return Er.apply(this,arguments)}function Er(){return(Er=R(S.mark((function e(t){var r;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Q.findAll({include:[{model:we,attributes:[]}],where:{id_ruta_padre:t},order:["orden"]});case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}fr=br;const Tr={$id:"http://example.com/schemas/rutaCreate.json#",type:"object",properties:{nombre:{type:"string",errorMessage:{type:"El nombre de la ruta debe ser de tipo alfanumerico"}},uri:{type:"string",errorMessage:{type:"La uri de la ruta debe ser de tipo alfanumerico"}},nombre_uri:{type:"string",errorMessage:{type:"El nombre de la ruta debe ser de tipo alfanumerico"}},mostrar:{type:"boolean",errorMessage:{type:"El parámetro mostrar de la ruta debe ser de tipo booleano"}},icono:{type:"string",errorMessage:{type:"El parámetro icono de la ruta debe ser de tipo alfanumerico"}},orden:{type:["number","null"],errorMessage:{type:"El parámetro orden de la ruta debe ser de tipo numérico"}},publico:{type:"boolean",errorMessage:{type:"El parámetro público de la ruta debe ser de tipo booleano"}},id_ruta_padre:{$ref:"defs.json#/definitions/intOrNull",errorMessage:{type:"El id de la ruta padre debe ser de tipo numérico"}}},required:["nombre","uri","mostrar","nombre_uri"],errorMessage:{required:{nombre:"El campo nombre de la ruta es requerido",mostrar:"El campo mostrar de la ruta es requerido",uri:"El campo uri de la ruta es requerido",nombre_uri:"El campo nombre_uri de la ruta es requerido"}}};var Or=(0,l.Router)();Or.get("/",[Qt("ROLE_PATH_LIST")],Bt(br.index)),Or.post("/",[Qt("ROLE_PATH_CREATE"),z(Tr)],Bt(br.store)),Or.get("/get-rutas",Bt(br.getRutas)),Or.get("/:id",[Qt("ROLE_PATH_LIST")],Bt(br.show)),Or.put("/:id",[Qt("ROLE_PATH_UPDATE"),z(Tr)],Bt(br.update));const Rr=Or;var Sr=function(){return o((function e(){a(this,e)}),null,[{key:"index",value:(u=R(S.mark((function e(t,r){var n,a,o;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n={},(a=t.query.nombre)&&(n.nombre=b({},B.Op.iLike,"%".concat(a,"%"))),e.next=5,Fe.findAll({include:[{model:et}],where:n});case 5:return o=e.sent,e.abrupt("return",r.status(_.HTTP_OK).json(o));case 7:case"end":return e.stop()}}),e)}))),function(e,t){return u.apply(this,arguments)})},{key:"listTipoServicio",value:(s=R(S.mark((function e(t,r){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,et.findAll({});case 2:return n=e.sent,e.abrupt("return",r.status(_.HTTP_OK).json(n));case 4:case"end":return e.stop()}}),e)}))),function(e,t){return s.apply(this,arguments)})},{key:"create",value:(i=R(S.mark((function e(t,r){var n,a,o,i,s,u,c,l;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.body,a=n.nombre,o=n.descripcion,i=n.precio_base,s=n.costo,u=n.id_tipo_servicio,e.next=3,U.connection().transaction();case 3:return c=e.sent,e.prev=4,e.next=7,Ct.exist(et,u,"Tipo de servicio no encontrado");case 7:return e.next=9,Fe.create({nombre:a,descripcion:o,precio_base:i,costo:s,id_tipo_servicio:u,fecha:new Date},{transaction:c});case 9:return l=e.sent,e.next=12,c.commit();case 12:return e.abrupt("return",r.status(_.HTTP_OK).json(l));case 15:throw e.prev=15,e.t0=e.catch(4),c.rollback(),e.t0;case 19:case"end":return e.stop()}}),e,null,[[4,15]])}))),function(e,t){return i.apply(this,arguments)})},{key:"show",value:(n=R(S.mark((function e(t,r){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Fe.findByPk(t.params.id,{});case 2:return n=e.sent,e.abrupt("return",r.status(_.HTTP_OK).json(n));case 4:case"end":return e.stop()}}),e)}))),function(e,t){return n.apply(this,arguments)})},{key:"update",value:(r=R(S.mark((function e(t,r){var n,a,o,i,s,u,c,l;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.body,a=n.nombre,o=n.descripcion,i=n.precio_base,s=n.costo,u=n.id_tipo_servicio,e.next=3,U.connection().transaction();case 3:return c=e.sent,e.prev=4,e.next=7,Ct.exist(et,u,"Tipo de servicio no encontrado");case 7:return e.next=9,Fe.update({nombre:a,descripcion:o,precio_base:i,costo:s,id_tipo_servicio:u,fecha:new Date},{where:{id:t.params.id},transaction:c});case 9:return l=e.sent,e.next=12,c.commit();case 12:return e.abrupt("return",r.status(_.HTTP_OK).json(l));case 15:throw e.prev=15,e.t0=e.catch(4),c.rollback(),e.t0;case 19:case"end":return e.stop()}}),e,null,[[4,15]])}))),function(e,t){return r.apply(this,arguments)})},{key:"getById",value:(t=R(S.mark((function e(t,r){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Fe.findByPk(t.params.id,{include:[{model:et}]});case 2:return n=e.sent,e.abrupt("return",r.status(_.HTTP_OK).json(n));case 4:case"end":return e.stop()}}),e)}))),function(e,r){return t.apply(this,arguments)})},{key:"destroy",value:(e=R(S.mark((function e(t,r){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Fe.findByPk(t.params.id);case 2:return n=e.sent,e.next=5,n.destroy();case 5:return e.abrupt("return",r.status(_.HTTP_OK).json(n));case 6:case"end":return e.stop()}}),e)}))),function(t,r){return e.apply(this,arguments)})}]);var e,t,r,n,i,s,u}(),Nr=(0,l.Router)();Nr.get("/tipo-servicio",[Kt],Sr.listTipoServicio);const qr=Nr;var jr=(0,l.Router)();jr.get("/",Bt(Sr.index)),jr.post("/",Bt(Sr.create)),jr.get("/:id",Bt(Sr.getById)),jr.put("/:id",Bt(Sr.update)),jr.delete("/:id",Bt(Sr.destroy));const Ar=jr;var Pr=function(){return o((function e(){a(this,e)}),null,[{key:"list",value:(i=R(S.mark((function e(t,r){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ut.findAll();case 2:n=e.sent,r.json(n);case 4:case"end":return e.stop()}}),e)}))),function(e,t){return i.apply(this,arguments)})},{key:"create",value:(n=R(S.mark((function e(t,r){var n,a,o,i,s;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.body,a=n.nombre,o=n.dui,i=n.email,e.next=3,ut.findOne({where:{email:i}});case 3:if(!e.sent){e.next=6;break}throw new Pt("Email ya existe");case 6:return e.next=8,ut.findOne({where:{dui:o}});case 8:if(!e.sent){e.next=11;break}throw new Pt("DUI ya existe");case 11:return e.next=13,ut.create({nombre:a,dui:o,email:i});case 13:s=e.sent,r.json(s);case 15:case"end":return e.stop()}}),e)}))),function(e,t){return n.apply(this,arguments)})},{key:"show",value:(r=R(S.mark((function e(t,r){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ut.findByPk(t.params.id);case 2:n=e.sent,r.json(n);case 4:case"end":return e.stop()}}),e)}))),function(e,t){return r.apply(this,arguments)})},{key:"update",value:(t=R(S.mark((function e(t,r){var n,a,o,i,s;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.body,a=n.nombre,o=n.dui,i=n.email,e.next=3,ut.findByPk(t.params.id);case 3:if(s=e.sent){e.next=6;break}throw new Pt("Cliente no existe");case 6:return e.next=8,ut.findOne({where:{email:i,id:b({},B.Op.ne,s.id)}});case 8:if(!e.sent){e.next=11;break}throw new Pt("Email ya existe");case 11:return e.next=13,ut.findOne({where:{dui:o,id:b({},B.Op.ne,s.id)}});case 13:if(!e.sent){e.next=16;break}throw new Pt("DUI ya existe");case 16:return s.nombre=a,s.dui=o,s.email=i,e.next=21,s.save();case 21:r.json(s);case 22:case"end":return e.stop()}}),e)}))),function(e,r){return t.apply(this,arguments)})},{key:"delete",value:(e=R(S.mark((function e(t,r){var n,a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.params.id,e.next=3,ut.findByPk(n);case 3:return a=e.sent,e.next=6,a.destroy();case 6:return e.abrupt("return",r.json({message:"cliente eliminado"}));case 7:case"end":return e.stop()}}),e)}))),function(t,r){return e.apply(this,arguments)})}]);var e,t,r,n,i}(),Ir=(0,l.Router)();Ir.get("/",Bt(Pr.list)),Ir.get("/:id",Bt(Pr.show)),Ir.post("/",Bt(Pr.create)),Ir.put("/:id",Bt(Pr.update)),Ir.delete("/:id",Bt(Pr.delete));const zr=Ir;function Mr(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return Kr(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Kr(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function Kr(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}var Dr=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],Lr=function(){return o((function e(){a(this,e)}),null,[{key:"index",value:(n=R(S.mark((function e(t,r){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,at.findAll({include:[{model:Qe},{model:ut}]});case 2:return n=e.sent,e.abrupt("return",r.status(_.HTTP_OK).json(n));case 4:case"end":return e.stop()}}),e)}))),function(e,t){return n.apply(this,arguments)})},{key:"create",value:(r=R(S.mark((function e(t,r){var n,a,o,i,s,u,c,l,d,p;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.body,a=n.id_cliente,o=n.detalle,i=n.servicios,s=t.usuario.id,e.next=4,U.connection().transaction();case 4:return u=e.sent,e.prev=5,e.next=8,at.create({id_cliente:a,id_empleado:s,fecha:new Date},{transaction:u});case 8:return c=e.sent,e.next=11,Qe.create({id_tipo_pago:1,id_venta:c.numero_factura,total:o.total,cantidad_servicios:o.cantidad_servicios,cambio:o.cambio,cantidad_pagada:o.cantidad_pagada},{transaction:u});case 11:l=Mr(i),e.prev=12,l.s();case 14:if((d=l.n()).done){e.next=20;break}return p=d.value,e.next=18,Ue.create({id_venta:c.numero_factura,id_servicio:p.id_servicio,cantidad:p.cantidad,subtotal:p.subtotal},{transaction:u});case 18:e.next=14;break;case 20:e.next=25;break;case 22:e.prev=22,e.t0=e.catch(12),l.e(e.t0);case 25:return e.prev=25,l.f(),e.finish(25);case 28:return e.next=30,u.commit();case 30:return e.abrupt("return",r.status(_.HTTP_OK).json(c));case 33:throw e.prev=33,e.t1=e.catch(5),u.rollback(),e.t1;case 37:case"end":return e.stop()}}),e,null,[[5,33],[12,22,25,28]])}))),function(e,t){return r.apply(this,arguments)})},{key:"show",value:(t=R(S.mark((function e(t,r){var n,a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.params.id,e.next=3,at.findByPk(n,{include:[{model:Qe},{model:Ue,include:[{model:Fe}]}]});case 3:if(a=e.sent){e.next=6;break}return e.abrupt("return",r.status(_.HTTP_NOT_FOUND).json({message:"Venta no encontrada"}));case 6:return e.abrupt("return",r.status(_.HTTP_OK).json(a));case 7:case"end":return e.stop()}}),e)}))),function(e,r){return t.apply(this,arguments)})},{key:"reporte",value:(e=R(S.mark((function e(t,r){var n,a,o,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.query.anio,e.next=3,at.findAll({where:{fecha:b(b({},B.Op.gte,new Date("".concat(n||(new Date).getFullYear(),"-01-01"))),B.Op.lte,new Date("".concat(n||(new Date).getFullYear(),"-12-31")))},include:[{model:Ue,include:[{model:Fe}]}]});case 3:return a=e.sent,o={},i={},a.forEach((function(e){e.ServicioVenta.forEach((function(e){var t=e.cantidad,r=e.Servicio.nombre;o[r]||(o[r]=0),o[r]+=t}));var t=Dr[new Date(e.fecha).getMonth()];i[t]||(i[t]=0),i[t]+=1})),e.abrupt("return",r.status(_.HTTP_OK).json({servicios:o,ventasMensuales:i}));case 8:case"end":return e.stop()}}),e)}))),function(t,r){return e.apply(this,arguments)})}]);var e,t,r,n}(),Br=(0,l.Router)();Br.get("/",[],Bt(Lr.index)),Br.get("/reporte",[],Bt(Lr.reporte)),Br.get("/:id",[],Bt(Lr.show)),Br.post("/",[],Bt(Lr.create));const Hr=Br;var Ur=(0,l.Router)();Ur.post("/v1/login",[z({$id:"http://example.com/schemas/login.json#",type:"object",properties:{email:{$ref:"defs.json#/definitions/email",errorMessage:{email:"El email debe ser de tipo alfanumerico"}},password:{$ref:"defs.json#/definitions/string"}},required:["email","password"],errorMessage:{required:{email:"El email es requerido",password:"La contraseña es requerida"}}})],Bt(It.login)),Ur.post("/v1/logout",[Kt],Bt(It.logout)),Ur.get("/v1/2fa",[Kt],Bt(It.twoFactorList)),Ur.post("/v1/2fa",[z({$id:"http://example.com/schemas/twoFactorAuth.json#",type:"object",properties:{id_metodo:{type:"integer",errorMessage:{email:"El id metodo de autenticación debe ser de tipo entero"}}},required:["id_metodo"],errorMessage:{required:{id_metodo:"El metodo de autenticación es requerido"}}})],Bt(It.twoFactorAuthLoginChoose)),Ur.post("/v1/2fa/verify",[Lt],Bt(It.verifyTwoFactorAuthCode)),Ur.post("/v1/2fa/code",[Lt],Bt(It.sendCode)),Ur.post("/v1/2fa/verification/token",Bt(It.sendVerificationToken)),Ur.get("/v1/verification/account/:token",Bt(It.confirmUser)),Ur.post("/v1/refresh",Bt(It.RefreshToken)),Ur.use("/v1/users",[Kt],Wt),Ur.use("/v1/perfiles",[Kt],pr),Ur.use("/v1/roles",[Kt],ar),Ur.use("/v1/tipo/roles",[Kt],sr),Ur.use("/v1/rutas",[Kt],Rr),Ur.put("/v1/password/change",[z({$id:"http://example.com/schemas/recoveryPasswordSchema.json#",type:"object",properties:{password:{$ref:"defs.json#/definitions/password"},confirm_password:{$ref:"defs.json#/definitions/password"}},required:["password","confirm_password"],errorMessage:{required:{password:"El campo password es requerido",confirm_password:"El campo confirmPassword es requerido"}}})],Bt(It.changePassword)),Ur.post("/v1/password/reset/",Bt(It.resetPassword)),Ur.use("/v1/catalogo",[Kt],qr),Ur.use("/v1/servicios",[Kt],Ar),Ur.use("/v1/clientes",[Kt],zr),Ur.use("/v1/ventas",[Kt],Hr);const Cr=Ur;var Gr=(0,l.Router)();Gr.get("/",(function(e,t){t.send('<h1 style="color:red">Welcome</h1>')}));const $r=Gr,Fr=require("http"),Vr=require("cors"),Yr=require("express-fileupload"),Zr={origin:"*",methods:"GET,HEAD,PUT,PATCH,POST,DELETE",preflightContinue:!1,exposedHeaders:["page","per_page","total_rows"],optionsSuccessStatus:204},Qr=new(function(){return o((function e(){a(this,e),this.app=l(),this.server=(0,Fr.createServer)(this.app),this.port="8000",this.host="localhost",this.middlewares()}),[{key:"middlewares",value:function(){this.app.use(Yr({createParentPath:!0})),this.app.use(Vr(Zr)),this.app.use(l.static("public")),this.app.use(l.json())}},{key:"start",value:function(){var e=this;this.server.listen(this.port,this.host,(function(){console.log("http://".concat(e.host,":").concat(e.port))}))}}])}()),Jr=require("swagger-ui-express"),Wr=require("yamljs"),Xr=require("url"),en=require("js-yaml"),tn=require("fs");var rn=(0,t.dirname)((0,Xr.fileURLToPath)("file:///home/willian/Projects/funeraria/api-funeraria/routes/swagger.mjs")),nn=Wr.load(t.join(rn,"../app/docs/index.yaml")),an=Wr.load(t.join(rn,"../app/docs/index.yaml")),on=Wr.load(t.join(rn,"../app/docs/index.yaml")),sn=(0,l.Router)();for(var un in on.paths)delete on.paths[un].area;var cn=en.dump(on);for(var ln in tn.writeFileSync(t.join(rn,"../app/docs/test.yaml"),cn,"utf8"),nn.info.title="Documentación de la API de la Plantilla - Development",an.paths)"development"===an.paths[ln].area&&delete an.paths[ln];for(var dn in nn.paths)"api"===nn.paths[dn].area&&delete nn.paths[dn];sn.use("/local",Jr.serveFiles(nn),Jr.setup(nn)),sn.use("/docs",Jr.serveFiles(an),Jr.setup(an)),sn.use("/api/doc.json",(function(e,r){r.header("Content-Type","application/json"),r.sendFile(t.join(rn,"../app/docs/test.json"))}));const pn=sn;new(function(){return o((function e(){a(this,e),this.server=Qr,this.configuracion(),this.server.start(),this.routes(),this.ExceptionConfig()}),[{key:"routes",value:function(){this.server.app.use("/",$r),this.server.app.use("/api",Cr),this.server.app.use("/",pn),this.server.app.all("*",(function(){throw new wt}))}},{key:"configuracion",value:function(){var e=i(c);this.server.app.use(s(e)),this.server.app.use(u(e))}},{key:"ExceptionConfig",value:function(){this.server.app.use(P.logErrorMiddleware),this.server.app.use(P.handlerError)}}])}())})()})();